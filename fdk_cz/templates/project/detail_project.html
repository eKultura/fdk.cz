{% extends "base.html" %}
{% load i18n %}
{% load functions %}

{% block title %}{{ project.name }} | FDK.cz{% endblock %}
{% block header_title %}{{ project.name }}{% endblock %}
{% block header_subtitle %}
{% if project.organization %}
Projekt pod organizac√≠ <strong>{{ project.organization.name }}</strong> &middot; {{ project.tasks.count }} √∫kol≈Ø
{% else %}
Voln√Ω projekt bez organizace &middot; {{ project.tasks.count }} √∫kol≈Ø
{% endif %}
{% endblock %}

{% block context_breadcrumbs %}
  <a href="{% url 'index_project_cs' %}" class="breadcrumb-link">Projekty</a>
  <span class="breadcrumb-sep">‚Üí</span>
  <span style="font-weight: 600; color: #1e293b;">{{ project.name }}</span>
{% endblock %}

{% block content %}
<div style="width: 100%;">

  <!-- Project Actions Bar -->
  <div style="display: flex; justify-content: flex-end; gap: 0.75rem; margin-bottom: 1.5rem;">
    {% if not is_project_closed %}
      <a href="{% url 'edit_project' project.project_id %}" class="btn btn-secondary" style="display: inline-flex; align-items: center; gap: 0.5rem;">
        ‚úèÔ∏è Upravit projekt
      </a>
    {% endif %}
    <a href="{% url 'project_settings' project.project_id %}" class="btn btn-outline" style="display: inline-flex; align-items: center; gap: 0.5rem;">
      ‚öôÔ∏è Nastaven√≠
    </a>
  </div>

  <!-- Project Closed Warning -->
  {% if is_project_closed %}
  <div class="content-card" style="border-left: 4px solid #ef4444; background: linear-gradient(to right, #fef2f2, #ffffff); margin-bottom: 2rem;">
    <div style="display: flex; align-items: center; gap: 1rem;">
      <div style="font-size: 2rem;">‚ö†Ô∏è</div>
      <div>
        <h3 style="font-weight: 600; color: #991b1b; margin: 0; margin-bottom: 0.25rem;">Tento projekt je UKONƒåEN</h3>
        <p style="color: #7f1d1d; margin: 0; font-size: 0.875rem;">
          Projekt byl ukonƒçen dne <strong>{{ project.end_date|date:"d.m.Y" }}</strong>. Nelze p≈ôid√°vat nov√Ω obsah.
        </p>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Tab Navigation -->
  <div class="tab-navigation">
    <button class="tab-button active" data-tab="overview">üìä P≈ôehled</button>
    <button class="tab-button" data-tab="tasks">‚úì √ökoly</button>
    <button class="tab-button" data-tab="gantt">üìÖ Gantt</button>
    <button class="tab-button" data-tab="documents">üìÑ Dokumenty</button>
    <button class="tab-button" data-tab="team">üë• T√Ωm</button>
    <button class="tab-button" data-tab="swot">üí° SWOT</button>
    <button class="tab-button" data-tab="testing">üêõ Testov√°n√≠</button>
    <button class="tab-button" data-tab="stores">üì¶ Sklady</button>
  </div>

  <!-- Tab: Overview -->
  <div class="tab-content active" id="tab-overview">
    <!-- Project Progress Chart -->
    <div class="content-card" style="margin-bottom: 2rem;">
      <h2 style="font-size: 1.125rem; font-weight: 600; margin-bottom: 1.5rem; color: #1e293b;">üìä Pr≈Øbƒõh projektu</h2>
      <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 2rem; align-items: center;">
        <!-- Chart -->
        <div style="max-width: 280px; margin: 0 auto;">
          <canvas id="overviewProjectChart"></canvas>
        </div>
        <!-- Stats List -->
        <div style="display: flex; flex-direction: column; gap: 1rem;">
          <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 1rem; background: #f8fafc; border-radius: 8px;">
            <div style="display: flex; align-items: center; gap: 0.75rem;">
              <div style="width: 12px; height: 12px; background: #94a3b8; border-radius: 50%;"></div>
              <span style="font-weight: 500; color: #475569;">Nezah√°jeno</span>
            </div>
            <span style="font-weight: 700; font-size: 1.25rem; color: #1e293b;">{{ project_status_counts.Nezah√°jeno|default:0 }}</span>
          </div>
          <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 1rem; background: #fef3c7; border-radius: 8px;">
            <div style="display: flex; align-items: center; gap: 0.75rem;">
              <div style="width: 12px; height: 12px; background: #eab308; border-radius: 50%;"></div>
              <span style="font-weight: 500; color: #a16207;">Prob√≠h√°</span>
            </div>
            <span style="font-weight: 700; font-size: 1.25rem; color: #a16207;">{{ project_status_counts.Prob√≠h√°|default:0 }}</span>
          </div>
          <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 1rem; background: #d1fae5; border-radius: 8px;">
            <div style="display: flex; align-items: center; gap: 0.75rem;">
              <div style="width: 12px; height: 12px; background: #22c55e; border-radius: 50%;"></div>
              <span style="font-weight: 500; color: #15803d;">Hotovo</span>
            </div>
            <span style="font-weight: 700; font-size: 1.25rem; color: #15803d;">{{ project_status_counts.Hotovo|default:0 }}</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Recent Activity -->
    <div class="content-card">
      <h2 style="font-size: 1.125rem; font-weight: 600; margin-bottom: 1.5rem; color: #1e293b;">üí¨ Posledn√≠ aktivita</h2>
      {% with recent_comments=project.tasks.all|slice:":5" %}
        {% if recent_comments %}
        <div style="display: flex; flex-direction: column; gap: 0.75rem;">
          {% for task in recent_comments %}
            {% if task.comments.count > 0 %}
              {% with last_comment=task.comments.first %}
                <div style="border-left: 3px solid #3b82f6; background: #f8fafc; border-radius: 8px; padding: 1rem; transition: all 0.2s;" onmouseover="this.style.background='#eff6ff'" onmouseout="this.style.background='#f8fafc'">
                  <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem;">
                    <a href="{% url 'detail_task' task.task_id %}" style="color: #1e293b; text-decoration: none; font-weight: 600; font-size: 0.9375rem;">
                      {{ task.title|safe }}
                    </a>
                    <span style="font-size: 0.75rem; color: #9ca3af; white-space: nowrap; margin-left: 1rem;">{{ last_comment.posted|timesince }}</span>
                  </div>
                  <p style="font-size: 0.875rem; color: #64748b; margin: 0.5rem 0; line-height: 1.5;">{{ last_comment.comment|truncatewords:25|safe }}</p>
                  <div style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.75rem; color: #94a3b8;">
                    <span>üë§ {{ last_comment.user.username }}</span>
                  </div>
                </div>
              {% endwith %}
            {% endif %}
          {% endfor %}
        </div>
        {% else %}
          {% with icon="üí¨" title="≈Ω√°dn√° aktivita" message="Zat√≠m nejsou ≈æ√°dn√© koment√°≈ôe k √∫kol≈Øm" %}
            {% include 'inc/components.html' with component='empty_state' %}
          {% endwith %}
        {% endif %}
      {% endwith %}
    </div>
  </div>

  <!-- Tab: Tasks -->
  <div class="tab-content" id="tab-tasks">
    <div class="content-card">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
        <h2 style="font-size: 1.25rem; font-weight: 600; margin: 0;">√ökoly projektu</h2>
        <div style="display: flex; gap: 0.75rem;">
          {% if not is_project_closed %}
          <a href="{% url 'create_task' project.project_id %}" class="btn btn-primary">Ôºã Nov√Ω √∫kol</a>
          {% endif %}
          <button id="toggleView" class="btn btn-outline">üìä Kanban</button>
        </div>
      </div>

      <!-- Table View -->
      <div id="task_table">
        <div class="overflow-x-auto">
          <table class="data-table">
            <thead>
              <tr>
                <th>N√°zev</th>
                <th>Status</th>
                <th class="hidden md:table-cell">Priorita</th>
                <th class="hidden sm:table-cell">P≈ôi≈ôazeno</th>
                <th class="hidden md:table-cell">Kategorie</th>
                <th class="text-right">Akce</th>
              </tr>
            </thead>
            <tbody>
              {% for task in tasks_to_do %}
              <tr>
                <td>
                  <a href="{% url 'detail_task' task.task_id %}" class="font-semibold text-blue-600 hover:underline">{{ task.title|safe }}</a>
                </td>
                <td>
                  <span class="badge badge-{{ task.status|slugify }}">{{ task.status|default:"Nezah√°jeno" }}</span>
                </td>
                <td class="hidden md:table-cell text-gray-600">{{ task.priority }}</td>
                <td class="hidden sm:table-cell text-gray-600">{{ task.assigned.username|default:"‚Äì" }}</td>
                <td class="hidden md:table-cell text-gray-600">
                  {% if task.category %}
                    <a href="{% url 'detail_category' task.category.category_id %}" class="text-blue-600 hover:underline">{{ task.category.name }}</a>
                  {% else %}
                    ‚Äì
                  {% endif %}
                </td>
                <td class="text-right">
                  <a href="{% url 'detail_task' task.task_id %}" class="btn btn-outline" style="padding: 0.25rem 0.75rem; font-size: 0.875rem;">Detail</a>
                </td>
              </tr>
              {% empty %}
              <tr><td colspan="6" class="data-table-empty">≈Ω√°dn√© √∫koly k zobrazen√≠</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      <!-- Kanban View -->
      <div id="task_columns" style="display: none; grid-template-columns: repeat(3, 1fr); gap: 1rem;">
        <!-- Nezah√°jeno -->
        <div style="background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 12px; padding: 1rem;">
          <h3 style="font-weight: 600; color: #475569; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
            <span style="width: 10px; height: 10px; background: #94a3b8; border-radius: 50%;"></span>
            Nezah√°jeno ({{ project_status_counts.Nezah√°jeno|default:0 }})
          </h3>
          <div style="display: flex; flex-direction: column; gap: 0.75rem; max-height: 500px; overflow-y: auto;">
            {% for task in tasks_by_status.Nezah√°jeno|slice:":20" %}
            <div style="background: white; border: 1px solid #e2e8f0; border-radius: 8px; padding: 0.75rem;">
              <a href="{% url 'detail_task' task.task_id %}" style="font-weight: 600; color: #3b82f6; text-decoration: none; display: block; margin-bottom: 0.5rem;">
                {{ task.title|safe }}
              </a>
              <div style="font-size: 0.75rem; color: #64748b; margin-bottom: 0.5rem;">
                {{ task.priority }}{% if task.assigned %} ¬∑ {{ task.assigned.username }}{% endif %}
              </div>
              <form method="post" action="{% url 'update_task_status' task.task_id 'Prob√≠h√°' %}">
                {% csrf_token %}
                <button type="submit" class="btn btn-outline" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">‚ñ∂ Zaƒç√≠t</button>
              </form>
            </div>
            {% empty %}
            <p style="color: #9ca3af; font-size: 0.875rem; text-align: center; padding: 1rem;">≈Ω√°dn√© √∫koly</p>
            {% endfor %}
          </div>
        </div>

        <!-- Prob√≠h√° -->
        <div style="background: #fefce8; border: 2px solid #fde047; border-radius: 12px; padding: 1rem;">
          <h3 style="font-weight: 600; color: #a16207; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
            <span style="width: 10px; height: 10px; background: #eab308; border-radius: 50%;"></span>
            Prob√≠h√° ({{ project_status_counts.Prob√≠h√°|default:0 }})
          </h3>
          <div style="display: flex; flex-direction: column; gap: 0.75rem; max-height: 500px; overflow-y: auto;">
            {% for task in tasks_by_status.Prob√≠h√°|slice:":20" %}
            <div style="background: white; border: 1px solid #fde047; border-radius: 8px; padding: 0.75rem;">
              <a href="{% url 'detail_task' task.task_id %}" style="font-weight: 600; color: #3b82f6; text-decoration: none; display: block; margin-bottom: 0.5rem;">
                {{ task.title|safe }}
              </a>
              <div style="font-size: 0.75rem; color: #64748b; margin-bottom: 0.5rem;">
                {{ task.priority }}{% if task.assigned %} ¬∑ {{ task.assigned.username }}{% endif %}
              </div>
              <form method="post" action="{% url 'update_task_status' task.task_id 'Hotovo' %}">
                {% csrf_token %}
                <button type="submit" class="btn btn-primary" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">‚úì Dokonƒçit</button>
              </form>
            </div>
            {% empty %}
            <p style="color: #9ca3af; font-size: 0.875rem; text-align: center; padding: 1rem;">≈Ω√°dn√© √∫koly</p>
            {% endfor %}
          </div>
        </div>

        <!-- Hotovo -->
        <div style="background: #f0fdf4; border: 2px solid #86efac; border-radius: 12px; padding: 1rem;">
          <h3 style="font-weight: 600; color: #15803d; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
            <span style="width: 10px; height: 10px; background: #22c55e; border-radius: 50%;"></span>
            Hotovo ({{ project_status_counts.Hotovo|default:0 }})
          </h3>
          <div style="display: flex; flex-direction: column; gap: 0.75rem; max-height: 500px; overflow-y: auto;">
            {% for task in tasks_by_status.Hotovo|slice:":20" %}
            <div style="background: white; border: 1px solid #86efac; border-radius: 8px; padding: 0.75rem; opacity: 0.85;">
              <a href="{% url 'detail_task' task.task_id %}" style="font-weight: 600; color: #3b82f6; text-decoration: none; display: block; margin-bottom: 0.25rem;">
                {{ task.title|safe }}
              </a>
              <div style="font-size: 0.75rem; color: #64748b;">
                {{ task.priority }}{% if task.assigned %} ¬∑ {{ task.assigned.username }}{% endif %}
              </div>
            </div>
            {% empty %}
            <p style="color: #9ca3af; font-size: 0.875rem; text-align: center; padding: 1rem;">≈Ω√°dn√© √∫koly</p>
            {% endfor %}
          </div>
        </div>
      </div>

      <!-- Task Stats Chart -->
      <div style="margin-top: 3rem; padding-top: 2rem; border-top: 1px solid #e5e7eb;">
        <h3 style="font-size: 1.125rem; font-weight: 600; margin-bottom: 1.5rem;">Statistika √∫kol≈Ø</h3>
        <div style="max-width: 400px; margin: 0 auto;">
          <canvas id="projectTaskPieChart"></canvas>
        </div>
      </div>

      <!-- Nice to Have Tasks -->
      {% if nice_to_have_tasks %}
      <div style="margin-top: 3rem; padding-top: 2rem; border-top: 1px solid #e5e7eb;">
        <h3 style="font-size: 1.125rem; font-weight: 600; margin-bottom: 0.5rem;">üí° Nice to Have √∫koly</h3>
        <p style="color: #64748b; font-size: 0.875rem; margin-bottom: 1.5rem;">√ökoly s n√≠zkou prioritou, kter√© by bylo hezk√© m√≠t, ale nejsou nezbytn√©</p>
        <div class="overflow-x-auto">
          <table class="data-table">
            <thead>
              <tr>
                <th>N√°zev</th>
                <th class="hidden md:table-cell">P≈ôi≈ôazeno</th>
                <th class="hidden md:table-cell">Kategorie</th>
                <th>Status</th>
                <th class="text-right">Akce</th>
              </tr>
            </thead>
            <tbody>
              {% for task in nice_to_have_tasks %}
              <tr>
                <td><a href="{% url 'detail_task' task.task_id %}" class="font-semibold text-blue-600 hover:underline">{{ task.title|safe }}</a></td>
                <td class="hidden md:table-cell text-gray-600">{{ task.assigned.username|default:"‚Äî" }}</td>
                <td class="hidden md:table-cell text-gray-600">{{ task.category.name|default:"‚Äî" }}</td>
                <td><span class="badge badge-{{ task.status|slugify }}">{{ task.status|default:"Nezah√°jeno" }}</span></td>
                <td class="text-right"><a href="{% url 'detail_task' task.task_id %}" class="btn btn-outline" style="padding: 0.25rem 0.75rem; font-size: 0.875rem;">Detail</a></td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      {% endif %}
    </div>
  </div>

  <!-- Tab: Gantt -->
  <div class="tab-content" id="tab-gantt">
    {% if gantt_items %}
    <div class="content-card" style="margin-bottom: 3rem;">
      <h2 style="font-size: 1.25rem; font-weight: 600; margin-bottom: 1rem;">üìÖ Gantt≈Øv diagram</h2>
      <p style="color: #64748b; font-size: 0.875rem; margin-bottom: 2rem;">ƒåasov√° osa miln√≠k≈Ø a vysokoprioritn√≠ch √∫kol≈Ø</p>

      <div style="position: relative; padding: 1rem 0;">
        <div style="position: absolute; left: 120px; right: 20px; top: 50%; height: 4px; background: linear-gradient(to right, #e5e7eb, #d1d5db); border-radius: 2px;"></div>
        <div style="display: flex; flex-direction: column; gap: 1rem; position: relative;">
          {% for item in gantt_items %}
          <div style="display: flex; align-items: center; gap: 1rem;">
            <div style="width: 100px; text-align: right; flex-shrink: 0;">
              <div style="font-weight: 600; font-size: 0.875rem; color: #1e293b;">{{ item.date|date:"d.m" }}</div>
              <div style="font-size: 0.7rem; color: #64748b;">{{ item.date|date:"Y" }}</div>
            </div>
            <div style="width: 16px; height: 16px; border-radius: 50%; flex-shrink: 0; z-index: 1;
                        {% if item.type == 'milestone' %}background: linear-gradient(135deg, #f59e0b, #d97706); box-shadow: 0 0 0 4px #fef3c7;
                        {% else %}background: linear-gradient(135deg, #3b82f6, #1d4ed8); box-shadow: 0 0 0 4px #dbeafe;{% endif %}">
            </div>
            <div style="flex: 1; background: white; border-radius: 8px; padding: 0.75rem; border: 1px solid #e5e7eb;">
              <div style="display: flex; align-items: center; gap: 0.5rem;">
                {% if item.type == 'milestone' %}
                  <span class="badge" style="background: #fef3c7; color: #92400e;">üìç Miln√≠k</span>
                {% else %}
                  <span class="badge" style="background: #dbeafe; color: #1e40af;">‚ö° Vysok√° priorita</span>
                {% endif %}
                <span style="font-weight: 600; color: #1e293b; font-size: 0.875rem;">{{ item.title }}</span>
              </div>
              {% if item.status %}
              <div style="margin-top: 0.25rem; font-size: 0.7rem; color: #64748b;">Status: {{ item.status }}</div>
              {% endif %}
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
    {% else %}
      {% with icon="üìÖ" title="≈Ω√°dn√© polo≈æky" message="P≈ôidejte miln√≠ky s term√≠ny nebo √∫koly s vysokou prioritou a deadlinem" %}
        {% include 'inc/components.html' with component='empty_state' %}
      {% endwith %}
    {% endif %}

    <!-- Milestones -->
    <div class="content-card">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
        <h2 style="font-size: 1.25rem; font-weight: 600; margin: 0;">üìç Miln√≠ky</h2>
        {% if not is_project_closed %}
        <a href="{% url 'create_milestone' project.project_id %}" class="btn btn-primary">Ôºã P≈ôidat miln√≠k</a>
        {% endif %}
      </div>
      <div class="overflow-x-auto">
        <table class="data-table">
          <thead>
            <tr>
              <th>N√°zev miln√≠ku</th>
              <th>Term√≠n dokonƒçen√≠</th>
              <th class="text-right">Akce</th>
            </tr>
          </thead>
          <tbody>
            {% for milestone in project.milestones.all %}
            <tr>
              <td><a href="{% url 'edit_milestone' project.project_id milestone.pk %}" class="font-semibold text-blue-600 hover:underline">{{ milestone.title|safe }}</a></td>
              <td class="text-gray-600">{{ milestone.due_date|date:"d.m.Y" }}</td>
              <td class="text-right">
                <div class="data-table-actions">
                  <a href="{% url 'edit_milestone' project.project_id milestone.pk %}">‚úèÔ∏è Upravit</a>
                  <a href="{% url 'delete_milestone' project.project_id milestone.pk %}" class="danger" onclick="return confirm('Opravdu chcete smazat tento miln√≠k?');">üóëÔ∏è Smazat</a>
                </div>
              </td>
            </tr>
            {% empty %}
            <tr><td colspan="3" class="data-table-empty">Zat√≠m nejsou vytvo≈ôeny ≈æ√°dn√© miln√≠ky</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Tab: Documents -->
  <div class="tab-content" id="tab-documents">
    <div class="content-card">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
        <h2 style="font-size: 1.25rem; font-weight: 600; margin: 0;">üìÑ Dokumenty</h2>
        {% if not is_project_closed %}
        <a href="{% url 'create_document' project.project_id %}" class="btn btn-primary">Ôºã P≈ôidat dokument</a>
        {% endif %}
      </div>
      <div class="overflow-x-auto">
        <table class="data-table">
          <thead>
            <tr>
              <th>N√°zev dokumentu</th>
              <th class="hidden md:table-cell">Kategorie</th>
              <th class="hidden md:table-cell">Typ</th>
              <th class="text-right">Akce</th>
            </tr>
          </thead>
          <tbody>
            {% for document in project.documents.all %}
            <tr>
              <td><a href="{% url 'detail_document' document.pk %}" class="font-semibold text-blue-600 hover:underline">{{ document.title|safe }}</a></td>
              <td class="hidden md:table-cell text-gray-600">{{ document.category|default:"‚Äì" }}</td>
              <td class="hidden md:table-cell text-gray-600">{{ document.document_type|default:"‚Äì" }}</td>
              <td class="text-right">
                <div class="data-table-actions">
                  <a href="{% url 'detail_document' document.pk %}">üëÅÔ∏è Detail</a>
                  <a href="{% url 'edit_document' document.pk %}">‚úèÔ∏è Upravit</a>
                  <a href="{% url 'delete_document' document.pk %}" class="danger" onclick="return confirm('Opravdu chcete smazat tento dokument?');">üóëÔ∏è Smazat</a>
                </div>
              </td>
            </tr>
            {% empty %}
            <tr><td colspan="4" class="data-table-empty">Zat√≠m nejsou vytvo≈ôeny ≈æ√°dn√© dokumenty</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Tab: Team -->
  <div class="tab-content" id="tab-team">
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; margin-bottom: 3rem;">
      <!-- Team Members -->
      <div class="content-card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
          <h2 style="font-size: 1.125rem; font-weight: 600; margin: 0;">üë• ƒålenov√© t√Ωmu</h2>
          {% if not is_project_closed %}
          <a href="{% url 'manage_project_users' project.project_id %}" class="btn btn-outline" style="font-size: 0.875rem;">Spravovat</a>
          {% endif %}
        </div>
        <ul class="content-list">
          {% for member in members %}
          <li class="content-list-item">
            <a href="{% url 'user_profile' %}?user_id={{ member.user.pk }}" class="content-list-item-text text-blue-600 hover:underline">{{ member.user.username }}</a>
            <a href="{% url 'remove_project_user' project.project_id member.user.pk %}" class="content-list-item-action danger">‚úñ</a>
          </li>
          {% empty %}
          <li class="content-list-empty">≈Ω√°dn√≠ ƒçlenov√©</li>
          {% endfor %}
        </ul>
      </div>

      <!-- Categories -->
      <div class="content-card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
          <h2 style="font-size: 1.125rem; font-weight: 600; margin: 0;">üè∑Ô∏è Kategorie</h2>
          {% if not is_project_closed %}
          <a href="{% url 'create_category' project.project_id %}" class="btn btn-outline" style="font-size: 0.875rem;">Ôºã P≈ôidat</a>
          {% endif %}
        </div>
        <ul class="content-list">
          {% for category in project.categories.all %}
          <li class="content-list-item">
            <a href="{% url 'detail_category' category.category_id %}" class="content-list-item-text text-blue-600 hover:underline">{{ category.name }}</a>
            <a href="{% url 'edit_category' category.category_id %}" class="content-list-item-action">‚úèÔ∏è</a>
          </li>
          {% empty %}
          <li class="content-list-empty">≈Ω√°dn√© kategorie</li>
          {% endfor %}
        </ul>
      </div>
    </div>

    <!-- Contacts -->
    <div class="content-card">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
        <h2 style="font-size: 1.25rem; font-weight: 600; margin: 0;">üë§ Kontakty projektu</h2>
        {% if not is_project_closed %}
        <a href="{% url 'create_contact_project' project.project_id %}" class="btn btn-primary">Ôºã Nov√Ω kontakt</a>
        {% endif %}
      </div>
      <div class="overflow-x-auto">
        <table class="data-table">
          <thead>
            <tr>
              <th>Jm√©no</th>
              <th class="hidden md:table-cell">E-mail</th>
              <th class="hidden md:table-cell">Telefon</th>
              <th class="hidden lg:table-cell">Firma</th>
              <th>Typ</th>
              <th class="text-right">Akce</th>
            </tr>
          </thead>
          <tbody>
            {% for contact in project.contacts.all %}
              {% if not contact.account or contact.account.id == user.id %}
              <tr>
                <td><a href="{% url 'detail_contact' contact.contact_id %}" class="font-semibold text-blue-600 hover:underline">{{ contact.first_name }} {{ contact.last_name|default:"" }}</a></td>
                <td class="hidden md:table-cell text-gray-600">{{ contact.email|default:"‚Äì" }}</td>
                <td class="hidden md:table-cell text-gray-600">{{ contact.phone|default:"‚Äì" }}</td>
                <td class="hidden lg:table-cell text-gray-600">{{ contact.company|default:"‚Äì" }}</td>
                <td>
                  {% if contact.account %}
                    <span class="badge" style="background: #dbeafe; color: #1e40af;">üîí Soukrom√Ω</span>
                  {% else %}
                    <span class="badge" style="background: #d1fae5; color: #065f46;">üë• Ve≈ôejn√Ω</span>
                  {% endif %}
                </td>
                <td class="text-right">
                  <div class="data-table-actions">
                    <a href="{% url 'detail_contact' contact.contact_id %}">üëÅÔ∏è Detail</a>
                    <a href="{% url 'edit_contact' contact.contact_id %}">‚úèÔ∏è Upravit</a>
                  </div>
                </td>
              </tr>
              {% endif %}
            {% empty %}
            <tr><td colspan="6" class="data-table-empty">Zat√≠m nejsou ≈æ√°dn√© kontakty k projektu</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Tab: SWOT -->
  <div class="tab-content" id="tab-swot">
    <div class="content-card">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
        <h2 style="font-size: 1.25rem; font-weight: 600; margin: 0;">üí° SWOT Anal√Ωzy</h2>
        {% if not is_project_closed %}
        <a href="{% url 'create_swot_analysis' %}?project_id={{ project.project_id }}" class="btn btn-primary">Ôºã Nov√° SWOT anal√Ωza</a>
        {% endif %}
      </div>
      <p style="color: #64748b; margin-bottom: 1.5rem;">SWOT anal√Ωza pom√°h√° identifikovat siln√© (Strengths) a slab√© (Weaknesses) str√°nky projektu, p≈ô√≠le≈æitosti (Opportunities) a hrozby (Threats).</p>

      {% if project.swot_analyses.all %}
      <div style="display: grid; gap: 1rem;">
        {% for swot in project.swot_analyses.all %}
        <div style="border: 1px solid #e2e8f0; border-radius: 8px; padding: 1.5rem;">
          <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
            <div>
              <h3 style="font-weight: 600; color: #1e293b; margin-bottom: 0.5rem;">
                <a href="{% url 'detail_swot_analysis' swot.swot_id %}" style="color: #3b82f6; text-decoration: none;">
                  {{ swot.title }}
                </a>
              </h3>
              <p style="color: #64748b; font-size: 0.875rem;">Vytvo≈ôeno: {{ swot.created_at|date:"d.m.Y H:i" }}</p>
            </div>
            <div style="display: flex; gap: 0.75rem;">
              <a href="{% url 'detail_swot_analysis' swot.swot_id %}" class="btn btn-outline btn-sm">üëÅÔ∏è Detail</a>
              <a href="{% url 'edit_swot_analysis' swot.swot_id %}" class="btn btn-outline btn-sm">‚úèÔ∏è Upravit</a>
            </div>
          </div>

          <!-- SWOT Grid Preview -->
          <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
            <div style="background: #d1fae5; padding: 1rem; border-radius: 8px;">
              <div style="font-weight: 600; color: #065f46; margin-bottom: 0.5rem;">üí™ Siln√© str√°nky</div>
              <div style="color: #047857; font-size: 0.875rem;">{{ swot.strengths|truncatewords:10 }}</div>
            </div>
            <div style="background: #fef3c7; padding: 1rem; border-radius: 8px;">
              <div style="font-weight: 600; color: #92400e; margin-bottom: 0.5rem;">‚ö†Ô∏è Slab√© str√°nky</div>
              <div style="color: #b45309; font-size: 0.875rem;">{{ swot.weaknesses|truncatewords:10 }}</div>
            </div>
            <div style="background: #dbeafe; padding: 1rem; border-radius: 8px;">
              <div style="font-weight: 600; color: #1e40af; margin-bottom: 0.5rem;">üéØ P≈ô√≠le≈æitosti</div>
              <div style="color: #1d4ed8; font-size: 0.875rem;">{{ swot.opportunities|truncatewords:10 }}</div>
            </div>
            <div style="background: #fee2e2; padding: 1rem; border-radius: 8px;">
              <div style="font-weight: 600; color: #991b1b; margin-bottom: 0.5rem;">‚ö° Hrozby</div>
              <div style="color: #dc2626; font-size: 0.875rem;">{{ swot.threats|truncatewords:10 }}</div>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
      {% else %}
      <div style="text-align: center; padding: 4rem 2rem; background: #f8fafc; border-radius: 8px;">
        <div style="font-size: 5rem; margin-bottom: 1rem;">üí°</div>
        <h3 style="font-size: 1.25rem; color: #64748b; margin-bottom: 1rem;">Zat√≠m nebyly vytvo≈ôeny ≈æ√°dn√© SWOT anal√Ωzy</h3>
        <p style="color: #94a3b8; margin-bottom: 2rem;">SWOT anal√Ωza v√°m pom≈Ø≈æe strategicky napl√°novat v√°≈° projekt</p>
        {% if not is_project_closed %}
        <a href="{% url 'create_swot_analysis' %}?project_id={{ project.project_id }}" class="btn btn-primary">
          Ôºã Vytvo≈ôit prvn√≠ SWOT anal√Ωzu
        </a>
        {% endif %}
      </div>
      {% endif %}
    </div>
  </div>

  <!-- Tab: Testing -->
  <div class="tab-content" id="tab-testing">
    <div class="content-card">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
        <h2 style="font-size: 1.25rem; font-weight: 600; margin: 0;">üêõ Chyby z testov√°n√≠</h2>
        {% if not is_project_closed %}
        <a href="{% url 'create_test_error_for_project' project.project_id %}" class="btn btn-primary">Ôºã Nov√° chyba</a>
        {% endif %}
      </div>
      <div class="overflow-x-auto">
        <table class="data-table">
          <thead>
            <tr>
              <th>N√°zev chyby</th>
              <th>Status</th>
              <th class="hidden md:table-cell">Vytvo≈ôil</th>
              <th class="hidden md:table-cell">Vytvo≈ôeno</th>
              <th class="text-right">Akce</th>
            </tr>
          </thead>
          <tbody>
            {% for error in all_errors %}
            <tr>
              <td><a href="{% url 'detail_test_error' error.test_error_id %}" class="font-semibold text-blue-600 hover:underline">{{ error.error_title|safe }}</a></td>
              <td>
                <span class="badge badge-{% if error.status == 'closed' %}green{% elif error.status == 'in_progress' %}orange{% else %}red{% endif %}">
                  {{ error.get_status_display }}
                </span>
              </td>
              <td class="hidden md:table-cell text-gray-600">{{ error.created_by.username|default:"‚Äì" }}</td>
              <td class="hidden md:table-cell text-gray-600">{{ error.date_created|date:"d.m.Y H:i" }}</td>
              <td class="text-right">
                <div class="data-table-actions">
                  <a href="{% url 'detail_test_error' error.test_error_id %}">üëÅÔ∏è Detail</a>
                  <a href="{% url 'edit_test_error' error.test_error_id %}">‚úèÔ∏è Upravit</a>
                </div>
              </td>
            </tr>
            {% empty %}
            <tr><td colspan="5" class="data-table-empty">Zat√≠m nejsou ≈æ√°dn√© otev≈ôen√© chyby z testov√°n√≠</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Tab: Stores -->
  <div class="tab-content" id="tab-stores">
    <div class="content-card">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
        <h2 style="font-size: 1.25rem; font-weight: 600; margin: 0;">üì¶ Sklady projektu</h2>
        <a href="{% url 'project_stores' project.project_id %}" class="btn btn-primary">Zobrazit sklady</a>
      </div>
      <p style="color: #64748b; line-height: 1.6;">
        Spravujte skladov√© z√°soby a polo≈æky p≈ôi≈ôazen√© k tomuto projektu.
        M≈Ø≈æete sledovat stav z√°sob, p≈ôid√°vat nov√© polo≈æky a evidovat pohyby materi√°lu.
      </p>
    </div>
  </div>

</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  // Tab Navigation with Hash Support
  const tabButtons = document.querySelectorAll('.tab-button');
  const tabContents = document.querySelectorAll('.tab-content');

  function switchTab(tabId) {
    // Remove active class from all
    tabButtons.forEach(btn => btn.classList.remove('active'));
    tabContents.forEach(content => content.classList.remove('active'));

    // Add active to selected
    const selectedButton = document.querySelector(`[data-tab="${tabId}"]`);
    const selectedContent = document.getElementById(`tab-${tabId}`);

    if (selectedButton && selectedContent) {
      selectedButton.classList.add('active');
      selectedContent.classList.add('active');

      // Update URL hash
      window.location.hash = tabId;
    }
  }

  // Handle button clicks
  tabButtons.forEach(button => {
    button.addEventListener('click', () => {
      switchTab(button.dataset.tab);
    });
  });

  // Handle URL hash on load
  if (window.location.hash) {
    const tabId = window.location.hash.substring(1);
    switchTab(tabId);
  }

  // Handle hash changes
  window.addEventListener('hashchange', () => {
    if (window.location.hash) {
      const tabId = window.location.hash.substring(1);
      switchTab(tabId);
    }
  });

  // Toggle Task View
  const toggleBtn = document.getElementById('toggleView');
  const taskColumns = document.getElementById('task_columns');
  const taskTable = document.getElementById('task_table');

  if (toggleBtn && taskColumns && taskTable) {
    toggleBtn.addEventListener('click', (e) => {
      e.preventDefault();
      if (taskTable.style.display === 'none') {
        taskTable.style.display = 'block';
        taskColumns.style.display = 'none';
        toggleBtn.textContent = 'üìä Kanban';
      } else {
        taskTable.style.display = 'none';
        taskColumns.style.display = 'grid';
        toggleBtn.textContent = 'üìã Tabulka';
      }
    });
  }

  // Chart.js - Overview Chart
  try {
    const overviewCtx = document.getElementById('overviewProjectChart');
    if (overviewCtx && typeof Chart !== 'undefined') {
      new Chart(overviewCtx, {
        type: 'doughnut',
        data: {
          labels: ['Nezah√°jeno', 'Prob√≠h√°', 'Hotovo'],
          datasets: [{
            data: [{{ project_status_counts.Nezah√°jeno|default:0 }}, {{ project_status_counts.Prob√≠h√°|default:0 }}, {{ project_status_counts.Hotovo|default:0 }}],
            backgroundColor: ['#94a3b8', '#eab308', '#22c55e'],
            borderWidth: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: {
              display: false
            }
          },
          cutout: '65%'
        }
      });
    }
  } catch (error) {
    console.error('Overview chart error:', error);
  }

  // Chart.js - Tasks Tab Chart
  try {
    const ctx = document.getElementById('projectTaskPieChart');
    if (ctx && typeof Chart !== 'undefined') {
      new Chart(ctx, {
        type: 'pie',
        data: {
          labels: ['Nezah√°jeno', 'Prob√≠h√°', 'Hotovo'],
          datasets: [{
            data: [{{ project_status_counts.Nezah√°jeno|default:0 }}, {{ project_status_counts.Prob√≠h√°|default:0 }}, {{ project_status_counts.Hotovo|default:0 }}],
            backgroundColor: ['#94a3b8', '#eab308', '#22c55e']
          }]
        },
        options: {responsive: true, maintainAspectRatio: true}
      });
    }
  } catch (error) {
    console.error('Chart initialization error:', error);
  }
});
</script>
{% endblock %}
