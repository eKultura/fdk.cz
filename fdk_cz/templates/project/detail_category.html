{% extends "base.html" %}
{% load i18n %}
{% load functions %}

{% block title %}{{ category.name }} | {{ project.name }} | FDK.cz{% endblock %}
{% block header_title %}{{ category.name }}{% endblock %}
{% block header_subtitle %}
Kategorie projektu <a href="{% url 'detail_project' project.project_id %}" class="text-blue-600 hover:underline"><strong>{{ project.name }}</strong></a> &middot; {{ category_total_tasks }} √∫kol≈Ø
{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto space-y-8">

  <!-- Breadcrumbs -->
  <nav class="text-sm text-gray-600 mb-4">
    <a href="{% url 'index_project_cs' %}" class="hover:text-blue-600">Projekty</a>
    <span class="mx-2">‚Ä∫</span>
    <a href="{% url 'detail_project' project.project_id %}" class="hover:text-blue-600">{{ project.name }}</a>
    <span class="mx-2">‚Ä∫</span>
    <span class="text-gray-900 font-semibold">{{ category.name }}</span>
  </nav>

  <!-- Popis kategorie -->
  {% if category.description %}
  <div class="content-card">
    <h2 class="text-xl font-semibold text-gray-800 mb-4">üìã Popis kategorie</h2>
    <p class="text-gray-700">{{ category.description }}</p>
  </div>
  {% endif %}

  <!-- Informace z HR oddƒõlen√≠ (pokud kategorie odpov√≠d√° oddƒõlen√≠) -->
  {% if department %}
  <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded-lg shadow-md">
    <div class="flex items-start">
      <div class="flex-shrink-0">
        <span class="text-2xl">üè¢</span>
      </div>
      <div class="ml-3">
        <h3 class="text-lg font-semibold text-blue-800">‚ÑπÔ∏è Propojen√≠ s HR oddƒõlen√≠m</h3>
        <p class="text-sm text-blue-700 mt-1">
          Tato kategorie odpov√≠d√° oddƒõlen√≠ <strong>{{ department.name }}</strong> v organizaci {{ project.organization.name }}.
        </p>

        {% if department_employees %}
        <div class="mt-3">
          <h4 class="text-sm font-semibold text-blue-800 mb-2">Zamƒõstnanci oddƒõlen√≠:</h4>
          <div class="overflow-x-auto">
            <table class="data-table">
              <thead>
                <tr>
                  <th>Jm√©no</th>
                  <th class="hidden md:table-cell">Pozice</th>
                  <th class="hidden md:table-cell">Email</th>
                  <th class="hidden lg:table-cell">Telefon</th>
                </tr>
              </thead>
              <tbody>
                {% for employee in department_employees %}
                <tr>
                  <td>
                    {% if employee.user %}
                      <a href="{% url 'user_profile' %}?user_id={{ employee.user.pk }}" class="text-blue-600 hover:underline font-semibold">
                        {{ employee.first_name }} {{ employee.last_name }}
                      </a>
                    {% else %}
                      <span class="font-semibold">{{ employee.first_name }} {{ employee.last_name }}</span>
                    {% endif %}
                  </td>
                  <td class="hidden md:table-cell text-gray-600">{{ employee.position|default:"‚Äì" }}</td>
                  <td class="hidden md:table-cell text-gray-600">{{ employee.email|default:"‚Äì" }}</td>
                  <td class="hidden lg:table-cell text-gray-600">{{ employee.phone|default:"‚Äì" }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
        {% else %}
        <p class="text-sm text-blue-600 mt-2">Oddƒõlen√≠ zat√≠m nem√° p≈ôi≈ôazen√© zamƒõstnance.</p>
        {% endif %}
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Sekce: √ökoly kategorie -->
  <div class="content-card">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-xl font-semibold text-gray-800">‚úÖ √ökoly kategorie</h2>
      <div class="flex gap-3">
        {% if not is_project_closed %}
        <a href="{% url 'create_task' project.project_id %}" class="btn btn-primary">Ôºã Nov√Ω √∫kol</a>
        {% endif %}
        <button id="toggleView" class="btn btn-outline">üìä Zobrazit Kanban</button>
      </div>
    </div>

    <!-- Tabulkov√© zobrazen√≠ (v√Ωchoz√≠) -->
    <div id="task_table" class="overflow-x-auto">
      <table class="data-table">
        <thead>
          <tr>
            <th>N√°zev</th>
            <th>Status</th>
            <th class="hidden md:table-cell">Priorita</th>
            <th class="hidden sm:table-cell">P≈ôi≈ôazeno</th>
            <th class="text-right">Akce</th>
          </tr>
        </thead>
        <tbody>
          {% for task in tasks_to_do %}
          <tr>
            <td>
              <a href="{% url 'detail_task' task.task_id %}" class="font-semibold text-blue-600 hover:underline">{{ task.title|safe }}</a>
            </td>
            <td>
              <span class="px-2 py-1 rounded text-xs font-semibold
                {% if task.status == 'Hotovo' %}bg-green-100 text-green-700
                {% elif task.status == 'Prob√≠h√°' %}bg-yellow-100 text-yellow-800
                {% else %}bg-gray-100 text-gray-700{% endif %}">
                {{ task.status|default:"Nezah√°jeno" }}
              </span>
            </td>
            <td class="hidden md:table-cell text-gray-600">{{ task.priority }}</td>
            <td class="hidden sm:table-cell text-gray-600">
              {% if task.assigned %}
                <a href="{% url 'user_profile' %}?user_id={{ task.assigned.pk }}" class="text-blue-600 hover:underline">{{ task.assigned.username }}</a>
              {% else %}
                ‚Äì
              {% endif %}
            </td>
            <td class="text-right">
              <div class="data-table-actions">
                <a href="{% url 'detail_task' task.task_id %}">üëÅÔ∏è Detail</a>
              </div>
            </td>
          </tr>
          {% empty %}
          <tr><td colspan="5" class="data-table-empty">≈Ω√°dn√© √∫koly k zobrazen√≠</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Sloupcov√© zobrazen√≠ (kanban) -->
    <div id="task_columns" style="display: none; grid-template-columns: repeat(3, 1fr); gap: 1rem;">
      <!-- Nezah√°jeno -->
      <div style="background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); border: 2px solid #e2e8f0; border-radius: 8px; padding: 1rem;">
        <h3 style="font-weight: 700; color: #475569; margin-bottom: 0.75rem; display: flex; align-items: center;">
          <span style="width: 10px; height: 10px; background: #94a3b8; border-radius: 50%; margin-right: 0.5rem;"></span>
          Nezah√°jeno ({{ category_status_counts.Nezah√°jeno|default:0 }})
        </h3>
        <div style="max-height: 500px; overflow-y: auto;">
          {% for task in tasks_by_status.Nezah√°jeno|slice:":20" %}
          <div style="background: white; border: 1px solid #e2e8f0; border-radius: 8px; padding: 0.75rem; margin-bottom: 0.5rem; box-shadow: 0 1px 2px rgba(0,0,0,0.05);">
            <a href="{% url 'detail_task' task.task_id %}" style="font-weight: 600; color: #3b82f6; text-decoration: none; display: block; margin-bottom: 0.5rem;">
              {{ task.title|safe }}
            </a>
            <div style="font-size: 0.75rem; color: #64748b; margin-bottom: 0.5rem;">
              <span style="font-weight: 500;">{{ task.priority }}</span>
              {% if task.assigned %} ¬∑ üë§ {{ task.assigned.username }}{% endif %}
            </div>
            <form method="post" action="{% url 'update_task_status' task.task_id 'Prob√≠h√°' %}" style="display: inline;">
              {% csrf_token %}
              <button type="submit" style="font-size: 0.75rem; background: #fef3c7; color: #92400e; padding: 0.25rem 0.5rem; border: none; border-radius: 4px; cursor: pointer;">
                ‚ñ∂ Zaƒç√≠t
              </button>
            </form>
          </div>
          {% empty %}
          <p style="color: #9ca3af; font-size: 0.875rem; text-align: center; padding: 1rem 0;">≈Ω√°dn√© √∫koly</p>
          {% endfor %}
        </div>
      </div>

      <!-- Prob√≠h√° -->
      <div style="background: linear-gradient(135deg, #fefce8 0%, #fef3c7 100%); border: 2px solid #fde047; border-radius: 8px; padding: 1rem;">
        <h3 style="font-weight: 700; color: #a16207; margin-bottom: 0.75rem; display: flex; align-items: center;">
          <span style="width: 10px; height: 10px; background: #eab308; border-radius: 50%; margin-right: 0.5rem;"></span>
          Prob√≠h√° ({{ category_status_counts.Prob√≠h√°|default:0 }})
        </h3>
        <div style="max-height: 500px; overflow-y: auto;">
          {% for task in tasks_by_status.Prob√≠h√°|slice:":20" %}
          <div style="background: white; border: 1px solid #fde047; border-radius: 8px; padding: 0.75rem; margin-bottom: 0.5rem; box-shadow: 0 1px 2px rgba(0,0,0,0.05);">
            <a href="{% url 'detail_task' task.task_id %}" style="font-weight: 600; color: #3b82f6; text-decoration: none; display: block; margin-bottom: 0.5rem;">
              {{ task.title|safe }}
            </a>
            <div style="font-size: 0.75rem; color: #64748b; margin-bottom: 0.5rem;">
              <span style="font-weight: 500;">{{ task.priority }}</span>
              {% if task.assigned %} ¬∑ üë§ {{ task.assigned.username }}{% endif %}
            </div>
            <form method="post" action="{% url 'update_task_status' task.task_id 'Hotovo' %}" style="display: inline;">
              {% csrf_token %}
              <button type="submit" style="font-size: 0.75rem; background: #d1fae5; color: #065f46; padding: 0.25rem 0.5rem; border: none; border-radius: 4px; cursor: pointer;">
                ‚úì Dokonƒçit
              </button>
            </form>
          </div>
          {% empty %}
          <p style="color: #9ca3af; font-size: 0.875rem; text-align: center; padding: 1rem 0;">≈Ω√°dn√© √∫koly</p>
          {% endfor %}
        </div>
      </div>

      <!-- Hotovo -->
      <div style="background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); border: 2px solid #86efac; border-radius: 8px; padding: 1rem;">
        <h3 style="font-weight: 700; color: #15803d; margin-bottom: 0.75rem; display: flex; align-items: center;">
          <span style="width: 10px; height: 10px; background: #22c55e; border-radius: 50%; margin-right: 0.5rem;"></span>
          Hotovo ({{ category_status_counts.Hotovo|default:0 }})
        </h3>
        <div style="max-height: 500px; overflow-y: auto;">
          {% for task in tasks_by_status.Hotovo|slice:":20" %}
          <div style="background: white; border: 1px solid #86efac; border-radius: 8px; padding: 0.75rem; margin-bottom: 0.5rem; box-shadow: 0 1px 2px rgba(0,0,0,0.05); opacity: 0.85;">
            <a href="{% url 'detail_task' task.task_id %}" style="font-weight: 600; color: #3b82f6; text-decoration: none; display: block; margin-bottom: 0.25rem;">
              {{ task.title|safe }}
            </a>
            <div style="font-size: 0.75rem; color: #64748b;">
              <span style="font-weight: 500;">{{ task.priority }}</span>
              {% if task.assigned %} ¬∑ üë§ {{ task.assigned.username }}{% endif %}
            </div>
          </div>
          {% empty %}
          <p style="color: #9ca3af; font-size: 0.875rem; text-align: center; padding: 1rem 0;">≈Ω√°dn√© dokonƒçen√© √∫koly</p>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>

  <!-- Sekce: Statistika √∫kol≈Ø -->
  <div class="content-card">
    <h2 class="text-xl font-semibold text-gray-800 mb-4">üìä Statistika √∫kol≈Ø kategorie</h2>

    <!-- Graf -->
    <div class="mb-6">
      <canvas id="categoryTaskPieChart" height="200"></canvas>
    </div>

    <!-- Statistiky v ≈ô√°dku -->
    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem;">
      <!-- Nezah√°jeno -->
      <div class="bg-gray-50 border-2 border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
        <div class="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-1">Nezah√°jeno</div>
        <div class="text-3xl font-bold text-gray-700">{{ category_status_counts.Nezah√°jeno|default:0 }}</div>
      </div>

      <!-- Prob√≠h√° -->
      <div class="bg-yellow-50 border-2 border-yellow-200 rounded-lg p-4 hover:shadow-md transition-shadow">
        <div class="text-xs font-semibold text-yellow-700 uppercase tracking-wide mb-1">Prob√≠h√°</div>
        <div class="text-3xl font-bold text-yellow-600">{{ category_status_counts.Prob√≠h√°|default:0 }}</div>
      </div>

      <!-- Hotovo -->
      <div class="bg-green-50 border-2 border-green-200 rounded-lg p-4 hover:shadow-md transition-shadow">
        <div class="text-xs font-semibold text-green-700 uppercase tracking-wide mb-1">Hotovo</div>
        <div class="text-3xl font-bold text-green-600">{{ category_status_counts.Hotovo|default:0 }}</div>
      </div>

      <!-- Celkem -->
      <div class="bg-blue-50 border-2 border-blue-200 rounded-lg p-4 hover:shadow-md transition-shadow">
        <div class="text-xs font-semibold text-blue-700 uppercase tracking-wide mb-1">Celkem</div>
        <div class="text-3xl font-bold text-blue-600">{{ category_total_tasks|default:0 }}</div>
      </div>
    </div>
  </div>

  <!-- Akce s kategori√≠ -->
  <div class="content-card">
    <h2 class="text-xl font-semibold text-gray-800 mb-4">‚öôÔ∏è Spr√°va kategorie</h2>
    <div class="flex gap-3">
      <a href="{% url 'edit_category' category.category_id %}" class="btn btn-outline">‚úèÔ∏è Upravit kategorii</a>
      <a href="{% url 'detail_project' project.project_id %}" class="btn btn-outline">‚Üê Zpƒõt na projekt</a>
    </div>
  </div>

</div>

<!-- Script: Chart.js + Toggle -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  // Toggle view functionality
  const toggleBtn = document.getElementById('toggleView');
  const taskColumns = document.getElementById('task_columns');
  const taskTable = document.getElementById('task_table');

  if (toggleBtn && taskColumns && taskTable) {
    toggleBtn.addEventListener('click', (e) => {
      e.preventDefault();

      if (taskTable.style.display === 'none') {
        taskTable.style.display = 'block';
        taskColumns.style.display = 'none';
        toggleBtn.textContent = 'üìä Zobrazit Kanban';
      } else {
        taskTable.style.display = 'none';
        taskColumns.style.display = 'grid';
        toggleBtn.textContent = 'üìã Zobrazit tabulku';
      }
    });
  }

  // Chart.js initialization
  try {
    const ctx = document.getElementById('categoryTaskPieChart');
    if (ctx && typeof Chart !== 'undefined') {
      new Chart(ctx, {
        type: 'pie',
        data: {
          labels: ['Nezah√°jeno', 'Prob√≠h√°', 'Hotovo'],
          datasets: [{
            data: [{{ category_status_counts.Nezah√°jeno }}, {{ category_status_counts.Prob√≠h√° }}, {{ category_status_counts.Hotovo }}],
            backgroundColor: ['#f87171', '#facc15', '#4ade80']
          }]
        },
        options: {responsive: true, maintainAspectRatio: false}
      });
    }
  } catch (error) {
    console.error('Chart initialization error:', error);
  }
});
</script>
{% endblock %}
