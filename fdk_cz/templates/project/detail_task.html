{% extends "base.html" %}
{% load i18n %}

{% block title %}{{ task.title }} | Detail Ãºkolu | FDK.cz{% endblock %}
{% block header_title %}{{ task.title }}{% endblock %}
{% block header_subtitle %}
{% if project %}
Ãškol v projektu <strong>{{ project.name }}</strong> &middot; Stav: {{ task.status|default:"NedefinovÃ¡n" }}
{% else %}
OsobnÃ­ Ãºkol &middot; Stav: {{ task.status|default:"NedefinovÃ¡n" }}
{% endif %}
{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
  <div class="content-card">

    <!-- ZÃ¡kladnÃ­ Ãºdaje o Ãºkolu -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6 pb-6 border-b border-gray-200">
      <div>
        <p class="text-sm text-gray-500 mb-1">Status</p>
        <p class="font-semibold text-gray-800">{{ task.status|default:"NedefinovÃ¡n" }}</p>
      </div>

      <div>
        <p class="text-sm text-gray-500 mb-1">Priorita</p>
        <p class="font-semibold text-gray-800">{{ task.priority|default:"-" }}</p>
      </div>

      <div>
        <p class="text-sm text-gray-500 mb-1">Kategorie</p>
        <p class="font-semibold text-gray-800">{{ task.category.name|default:"-" }}</p>
      </div>

      <div>
        <p class="text-sm text-gray-500 mb-1">PÅ™iÅ™azeno</p>
        <p class="font-semibold text-gray-800">
          {% if task.assigned %}
            {{ task.assigned.username }}
          {% else %}
            <span class="text-gray-400">NepÅ™iÅ™azeno</span>
          {% endif %}
        </p>
      </div>

      <div>
        <p class="text-sm text-gray-500 mb-1">VytvoÅ™eno</p>
        <p class="font-semibold text-gray-800">{{ task.created|date:"d.m.Y" }}</p>
      </div>

      <div>
        <p class="text-sm text-gray-500 mb-1">TermÃ­n dokonÄenÃ­</p>
        <p class="font-semibold {% if task.due_date and task.due_date < today and task.status != 'Hotovo' %}text-red-600{% else %}text-gray-800{% endif %}">
          {{ task.due_date|date:"d.m.Y"|default:"â€“" }}
          {% if task.due_date and task.due_date < today and task.status != 'Hotovo' %}
            <span class="ml-2 text-xs bg-red-100 text-red-700 px-2 py-1 rounded">âš ï¸ Po termÃ­nu</span>
          {% endif %}
        </p>
      </div>
    </div>

    <!-- Popis -->
    {% if task.description %}
    <div class="mb-6 pb-6 border-b border-gray-200">
      <h3 class="text-sm text-gray-500 mb-2">Popis</h3>
      <p class="text-gray-800">{{ task.description }}</p>
    </div>
    {% endif %}

    <!-- NadÅ™azenÃ½ Ãºkol -->
    {% if task.parent %}
    <div class="mb-6 pb-6 border-b border-gray-200">
      <h3 class="text-sm text-gray-500 mb-2">NadÅ™azenÃ½ Ãºkol</h3>
      <a href="{% url 'detail_task' task.parent.task_id %}" class="text-blue-600 hover:underline font-medium">
        {{ task.parent.title }}
      </a>
    </div>
    {% endif %}

    <!-- PodÃºkoly -->
    {% if task.subtasks.exists %}
    <div class="mb-6 pb-6 border-b border-gray-200">
      <h3 class="text-sm text-gray-500 mb-3">PodÃºkoly</h3>
      <ul class="content-list">
        {% for subtask in task.subtasks.all %}
          <li class="content-list-item">
            <a href="{% url 'detail_task' subtask.task_id %}" class="content-list-item-text text-blue-600 hover:underline">
              {{ subtask.title }}
            </a>
            <span class="text-xs text-gray-500">{{ subtask.status }}</span>
          </li>
        {% endfor %}
      </ul>
    </div>
    {% endif %}

    <!-- AkÄnÃ­ tlaÄÃ­tka -->
    <div class="flex flex-wrap justify-between items-center gap-3 pb-6 border-b border-gray-200">
      <div class="flex flex-wrap gap-3">
        {% if task.status != "Hotovo" %}
        <form action="{% url 'update_task_status' task.task_id 'Hotovo' %}" method="post" class="inline">
          {% csrf_token %}
          <button type="submit" class="btn btn-success">âœ… OznaÄit jako hotovÃ©</button>
        </form>
        {% endif %}

        <a href="{% url 'edit_task' task.task_id %}" class="btn btn-primary">âœï¸ Upravit</a>

        <a href="{% url 'delete_task' task.task_id %}"
           class="btn btn-danger"
           onclick="return confirm('Opravdu chcete smazat tento Ãºkol?');">
          ğŸ—‘ï¸ Smazat
        </a>
      </div>

      <div>
        {% if project %}
          <a href="{% url 'detail_project' project.project_id %}" class="btn btn-outline">â† ZpÄ›t na projekt</a>
        {% else %}
          <a href="{% url 'task_management' %}" class="btn btn-outline">â† ZpÄ›t na Ãºkoly</a>
        {% endif %}
      </div>
    </div>

    <!-- KomentÃ¡Å™e -->
    <div class="mt-6">
      <h3 class="text-xl font-semibold text-gray-800 mb-4">ğŸ’¬ KomentÃ¡Å™e</h3>

      {% if comments %}
      <div class="space-y-4 mb-6">
        {% for comment in comments %}
          {% if comment.user == user %}
            <!-- MÅ¯j komentÃ¡Å™ (vpravo) -->
            <div class="flex justify-end">
              <div class="max-w-[75%]">
                <div class="bg-blue-600 text-white rounded-lg rounded-tr-none p-4 shadow-md">
                  <p class="leading-relaxed">{{ comment.comment }}</p>
                </div>
                <div class="text-xs text-gray-500 mt-1 text-right">
                  <span class="font-medium">{{ comment.user.username }}</span> â€¢ {{ comment.posted|date:"d.m.Y H:i" }}
                </div>
              </div>
            </div>
          {% else %}
            <!-- KomentÃ¡Å™ od jinÃ©ho uÅ¾ivatele (vlevo) -->
            <div class="flex justify-start">
              <div class="max-w-[75%]">
                <div class="bg-gray-100 border-2 border-gray-200 rounded-lg rounded-tl-none p-4 shadow-sm">
                  <p class="leading-relaxed text-gray-800">{{ comment.comment }}</p>
                </div>
                <div class="text-xs text-gray-500 mt-1">
                  <span class="font-medium">{{ comment.user.username|default:"Anonym" }}</span> â€¢ {{ comment.posted|date:"d.m.Y H:i" }}
                </div>
              </div>
            </div>
          {% endif %}
        {% endfor %}
      </div>
      {% else %}
      <p class="text-gray-500 mb-6 text-center py-4">ZatÃ­m Å¾Ã¡dnÃ© komentÃ¡Å™e.</p>
      {% endif %}

      <!-- PÅ™idat komentÃ¡Å™ -->
      <form method="post" action="{% url 'detail_task' task.task_id %}">
        {% csrf_token %}
        <div class="form-group">
          <label for="id_comment" class="form-label">PÅ™idat komentÃ¡Å™</label>
          <textarea name="comment" id="id_comment" rows="4"
                    class="form-control"
                    placeholder="NapiÅ¡te vÃ¡Å¡ komentÃ¡Å™ k tomuto Ãºkolu..."></textarea>
          <div class="form-help">KomentÃ¡Å™e jsou viditelnÃ© pro vÅ¡echny Äleny tÃ½mu</div>
        </div>
        <div class="flex justify-end">
          <button type="submit" class="btn btn-primary">ğŸ’¬ PÅ™idat komentÃ¡Å™</button>
        </div>
      </form>
    </div>

  </div>
</div>
{% endblock %}
