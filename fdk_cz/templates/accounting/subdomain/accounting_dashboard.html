{% extends "accounting/subdomain/base.html" %}

{% block title %}Dashboard | ÃšÄetnictvÃ­{% endblock %}

{% block content %}

<!-- COCKPIT HEADER -->
<div class="card glass mb-8 p-8 border-4 border-purple-200">
    <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center space-y-4 lg:space-y-0">

        <div class="flex-1">
            <h2 class="text-3xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-purple-600 to-pink-600 mb-2">
                ğŸ›« Cockpit â€“ FinanÄnÃ­ Å˜Ã­zenÃ­
            </h2>
            {% if current_context %}
            <p class="text-gray-600 font-medium">
                {{ current_context.name }} â€¢ ObdobÃ­ {{ current_context.fiscal_year }}
            </p>
            {% else %}
            <p class="text-yellow-600 font-semibold">âš ï¸ NenÃ­ aktivnÃ­ Å¾Ã¡dnÃ½ ÃºÄetnÃ­ kontext</p>
            {% endif %}
        </div>

        {% if user.is_authenticated %}
        <div class="flex space-x-3">
            <a href="{% url 'select_accounting_context' %}" class="btn btn-outline">
                ğŸ”„ ZmÄ›nit kontext
            </a>
            <a href="{% url 'create_invoice' %}" class="btn btn-success">
                â• NovÃ¡ faktura
            </a>
        </div>
        {% endif %}

    </div>
</div>


<!-- VÃSLEDOVKA - KPI CARDS -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">

    <!-- VÃNOSY -->
    <div class="kpi-card kpi-gradient-green">
        <div class="relative z-10">
            <div class="flex items-center justify-between mb-2">
                <span class="text-white/80 text-sm font-semibold uppercase">ğŸ’° VÃ½nosy</span>
                <span class="text-white/60 text-xs">(6xx ÃºÄty)</span>
            </div>
            <h3 class="number-display text-4xl lg:text-5xl mb-1">
                {{ total_revenues|floatformat:0 }}
            </h3>
            <p class="text-white/90 text-sm font-medium">KÄ</p>
            <div class="mt-4 h-1 bg-white/30 rounded-full overflow-hidden">
                <div class="h-full bg-white rounded-full" style="width: 85%;"></div>
            </div>
        </div>
    </div>

    <!-- NÃKLADY -->
    <div class="kpi-card kpi-gradient-red">
        <div class="relative z-10">
            <div class="flex items-center justify-between mb-2">
                <span class="text-white/80 text-sm font-semibold uppercase">ğŸ’¸ NÃ¡klady</span>
                <span class="text-white/60 text-xs">(5xx ÃºÄty)</span>
            </div>
            <h3 class="number-display text-4xl lg:text-5xl mb-1">
                {{ total_expenses|floatformat:0 }}
            </h3>
            <p class="text-white/90 text-sm font-medium">KÄ</p>
            <div class="mt-4 h-1 bg-white/30 rounded-full overflow-hidden">
                <div class="h-full bg-white rounded-full" style="width: 65%;"></div>
            </div>
        </div>
    </div>

    <!-- HOSPODÃÅ˜SKÃ VÃSLEDEK -->
    <div class="kpi-card {% if profit >= 0 %}kpi-gradient-blue{% else %}kpi-gradient-red{% endif %}">
        <div class="relative z-10">
            <div class="flex items-center justify-between mb-2">
                <span class="text-white/80 text-sm font-semibold uppercase">ğŸ“Š HV</span>
                <span class="text-white/60 text-xs">Zisk/ZtrÃ¡ta</span>
            </div>
            <h3 class="number-display text-4xl lg:text-5xl mb-1">
                {% if profit >= 0 %}+{% endif %}{{ profit|floatformat:0 }}
            </h3>
            <p class="text-white/90 text-sm font-medium">KÄ</p>
            <div class="mt-4 flex items-center space-x-2">
                {% if profit >= 0 %}
                <span class="text-2xl">ğŸ“ˆ</span>
                <span class="text-white/90 text-sm font-semibold">RÅ¯st</span>
                {% else %}
                <span class="text-2xl">ğŸ“‰</span>
                <span class="text-white/90 text-sm font-semibold">Pokles</span>
                {% endif %}
            </div>
        </div>
    </div>

</div>


<!-- RYCHLÃ NAVIGACE -->
<div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">

    <a href="{% url 'create_invoice' %}" class="card p-6 text-center hover:shadow-2xl group">
        <div class="text-5xl mb-3 group-hover:scale-110 transform">ğŸ“„</div>
        <h3 class="font-bold text-lg text-gray-800 mb-1">Faktury</h3>
        <p class="text-xs text-gray-500">VystavenÃ­ a sprÃ¡va</p>
    </a>

    <a href="{% url 'journal_ledger' %}" class="card p-6 text-center hover:shadow-2xl group">
        <div class="text-5xl mb-3 group-hover:scale-110 transform">ğŸ“š</div>
        <h3 class="font-bold text-lg text-gray-800 mb-1">DenÃ­k</h3>
        <p class="text-xs text-gray-500">ZaÃºÄtovÃ¡nÃ­ MD/D</p>
    </a>

    <a href="{% url 'balance_sheet_view' 'opening' %}" class="card p-6 text-center hover:shadow-2xl group">
        <div class="text-5xl mb-3 group-hover:scale-110 transform">ğŸ“Š</div>
        <h3 class="font-bold text-lg text-gray-800 mb-1">Rozvaha</h3>
        <p class="text-xs text-gray-500">Stav ÃºÄtÅ¯</p>
    </a>

    <a href="{% url 'chart_of_accounts' %}" class="card p-6 text-center hover:shadow-2xl group">
        <div class="text-5xl mb-3 group-hover:scale-110 transform">ğŸ“‹</div>
        <h3 class="font-bold text-lg text-gray-800 mb-1">Osnova</h3>
        <p class="text-xs text-gray-500">SprÃ¡va ÃºÄtÅ¯</p>
    </a>

</div>


<!-- DENÃK -->
{% if recent_journal_entries %}
<div class="card p-6 mb-8">
    <div class="flex justify-between items-center mb-6">
        <h3 class="text-2xl font-bold text-gray-800 flex items-center">
            <span class="mr-3 text-3xl">ğŸ“š</span>
            PoslednÃ­ zÃ¡znamy v denÃ­ku
        </h3>
        <a href="{% url 'journal_ledger' %}" class="text-purple-600 hover:text-purple-800 font-semibold text-sm flex items-center">
            CelÃ½ denÃ­k
            <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
            </svg>
        </a>
    </div>

    <div class="overflow-x-auto">
        <table class="data-table">
            <thead>
                <tr>
                    <th>Datum</th>
                    <th>Popis</th>
                    <th class="text-right">MD</th>
                    <th class="text-right">D</th>
                </tr>
            </thead>
            <tbody>
                {% for entry in recent_journal_entries %}
                <tr>
                    <td class="font-semibold text-gray-700">
                        {{ entry.entry_date|date:"d.m.Y" }}
                    </td>
                    <td>
                        <p class="font-semibold text-gray-800">{{ entry.description }}</p>
                        <p class="text-xs text-gray-500 mt-1">
                            {% for line in entry.lines.all|slice:":2" %}
                                {{ line.account.account_number }} {{ line.account.name }}{% if not forloop.last %} â€¢ {% endif %}
                            {% endfor %}
                        </p>
                    </td>
                    <td class="text-right number-display text-blue-700 font-bold">
                        {{ entry.total_debit|floatformat:2 }}
                    </td>
                    <td class="text-right number-display text-green-700 font-bold">
                        {{ entry.total_credit|floatformat:2 }}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}


<!-- FAKTURY -->
<div class="card p-6">
    <div class="flex justify-between items-center mb-6">
        <h3 class="text-2xl font-bold text-gray-800 flex items-center">
            <span class="mr-3 text-3xl">ğŸ“„</span>
            NedÃ¡vnÃ© faktury
        </h3>
        <div class="flex space-x-3">
            <a href="{% url 'create_invoice' %}" class="btn btn-success text-sm">
                â• NovÃ¡ faktura
            </a>
            <a href="{% url 'list_invoices' %}" class="btn btn-outline text-sm">
                VÅ¡echny faktury
            </a>
        </div>
    </div>

    {% if invoices %}
    <div class="overflow-x-auto">
        <table class="data-table">
            <thead>
                <tr>
                    <th>ÄŒÃ­slo</th>
                    <th class="hidden md:table-cell">PlÃ¡tce</th>
                    <th class="text-right">ÄŒÃ¡stka</th>
                    <th>Stav</th>
                    <th class="text-center">Akce</th>
                </tr>
            </thead>
            <tbody>
                {% for invoice in invoices %}
                <tr>
                    <td class="font-bold text-purple-700">
                        {{ invoice.invoice_number }}
                    </td>
                    <td class="hidden md:table-cell text-gray-600">
                        {{ invoice.company.name|default:"â€”" }}
                    </td>
                    <td class="text-right number-display text-gray-900 font-bold text-lg">
                        {{ invoice.total_amount|default:"0"|floatformat:0 }} KÄ
                    </td>
                    <td>
                        {% if invoice.status == 'paid' %}
                            <span class="badge badge-success">âœ“ Zaplaceno</span>
                        {% elif invoice.status == 'pending' %}
                            <span class="badge badge-warning">â³ ÄŒekÃ¡</span>
                        {% elif invoice.status == 'overdue' %}
                            <span class="badge badge-danger">âš ï¸ Po splatnosti</span>
                        {% else %}
                            <span class="badge badge-info">{{ invoice.status }}</span>
                        {% endif %}
                    </td>
                    <td class="text-center">
                        <div class="flex justify-center space-x-2">
                            <a href="{% url 'detail_invoice' invoice.id %}" class="text-blue-600 hover:text-blue-800 font-semibold text-sm">
                                ğŸ‘ï¸ Detail
                            </a>
                            <a href="{% url 'edit_invoice' invoice.id %}" class="text-yellow-600 hover:text-yellow-800 font-semibold text-sm">
                                âœï¸ Upravit
                            </a>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="text-center py-12">
        <div class="text-6xl mb-4">ğŸ“„</div>
        <h4 class="text-xl font-bold text-gray-700 mb-2">ZatÃ­m nemÃ¡te Å¾Ã¡dnÃ© faktury</h4>
        <p class="text-gray-500 mb-6">VytvoÅ™te svou prvnÃ­ fakturu a zaÄnÄ›te Å™Ã­dit finance jako profÃ­ci</p>
        <a href="{% url 'create_invoice' %}" class="btn btn-success">
            â• VytvoÅ™it prvnÃ­ fakturu
        </a>
    </div>
    {% endif %}
</div>

<!-- GRAFICKÃ PÅ˜EHLED (NovÃ¡ sekce) -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-8">
    <!-- Doughnut Chart - VÃ½sledovka -->
    <div class="card p-6">
        <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
            <span class="mr-2">ğŸ“Š</span> VÃ½sledovka 2025
        </h3>
        <div style="position: relative; height: 300px;">
            <canvas id="financeChart"></canvas>
        </div>
    </div>

    <!-- Line Chart - MÄ›sÃ­ÄnÃ­ trend -->
    <div class="card p-6">
        <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
            <span class="mr-2">ğŸ“ˆ</span> MÄ›sÃ­ÄnÃ­ trend
        </h3>
        <div style="position: relative; height: 300px;">
            <canvas id="trendChart"></canvas>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // ========================================
    // ANIMOVANÃ‰ POÄŒÃTADLA (CountUp effect)
    // ========================================
    function animateValue(element, start, end, duration) {
        if (!element) return;

        let startTimestamp = null;
        const step = (timestamp) => {
            if (!startTimestamp) startTimestamp = timestamp;
            const progress = Math.min((timestamp - startTimestamp) / duration, 1);
            const value = Math.floor(progress * (end - start) + start);
            element.textContent = value.toLocaleString('cs-CZ');
            if (progress < 1) {
                window.requestAnimationFrame(step);
            }
        };
        window.requestAnimationFrame(step);
    }

    // Animace ÄÃ­sel v KPI kartÃ¡ch
    const revenues = {{ total_revenues|default:0 }};
    const expenses = {{ total_expenses|default:0 }};
    const profit = {{ profit|default:0 }};

    // Najdi elementy s ÄÃ­sly a animuj je
    const revenueElement = document.querySelector('.kpi-gradient-green .number-display');
    const expenseElement = document.querySelector('.kpi-gradient-red .number-display');
    const profitElement = document.querySelector('[class*="kpi-gradient-"][class*="profit"] .number-display, .kpi-gradient-blue .number-display');

    if (revenueElement) animateValue(revenueElement, 0, revenues, 1500);
    if (expenseElement) animateValue(expenseElement, 0, expenses, 1500);
    if (profitElement) animateValue(profitElement, 0, Math.abs(profit), 1500);

    // ========================================
    // GRAF VÃSLEDOVKY (Doughnut Chart)
    // ========================================
    const ctx = document.getElementById('financeChart');
    if (ctx) {
        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['VÃ½nosy', 'NÃ¡klady', 'Zisk'],
                datasets: [{
                    data: [revenues, expenses, Math.abs(profit)],
                    backgroundColor: [
                        'rgba(17, 153, 142, 0.8)',  // ZelenÃ¡ (vÃ½nosy)
                        'rgba(238, 9, 121, 0.8)',   // ÄŒervenÃ¡ (nÃ¡klady)
                        'rgba(79, 172, 254, 0.8)'   // ModrÃ¡ (zisk)
                    ],
                    borderColor: [
                        'rgba(17, 153, 142, 1)',
                        'rgba(238, 9, 121, 1)',
                        'rgba(79, 172, 254, 1)'
                    ],
                    borderWidth: 3,
                    hoverOffset: 15
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            font: {
                                size: 14,
                                family: 'Inter',
                                weight: '600'
                            },
                            padding: 20,
                            usePointStyle: true,
                            pointStyle: 'circle'
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        padding: 12,
                        titleFont: {
                            size: 16,
                            weight: 'bold'
                        },
                        bodyFont: {
                            size: 14
                        },
                        callbacks: {
                            label: function(context) {
                                return context.label + ': ' + context.parsed.toLocaleString('cs-CZ') + ' KÄ';
                            }
                        }
                    }
                },
                animation: {
                    animateRotate: true,
                    animateScale: true,
                    duration: 1500,
                    easing: 'easeInOutQuart'
                }
            }
        });
    }

    // ========================================
    // TREND GRAF (Line Chart pro mÄ›sÃ­ÄnÃ­ trendy)
    // ========================================
    const trendCtx = document.getElementById('trendChart');
    if (trendCtx) {
        new Chart(trendCtx, {
            type: 'line',
            data: {
                labels: ['Led', 'Ãšno', 'BÅ™e', 'Dub', 'KvÄ›', 'ÄŒer', 'ÄŒvc', 'Srp', 'ZÃ¡Å™', 'Å˜Ã­j', 'Lis', 'Pro'],
                datasets: [
                    {
                        label: 'VÃ½nosy',
                        data: [120000, 150000, 180000, 160000, 190000, 210000, 195000, 220000, 240000, 235000, 250000, 270000],
                        borderColor: 'rgba(17, 153, 142, 1)',
                        backgroundColor: 'rgba(17, 153, 142, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 5,
                        pointHoverRadius: 8
                    },
                    {
                        label: 'NÃ¡klady',
                        data: [80000, 95000, 110000, 105000, 120000, 130000, 125000, 135000, 145000, 140000, 150000, 160000],
                        borderColor: 'rgba(238, 9, 121, 1)',
                        backgroundColor: 'rgba(238, 9, 121, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 5,
                        pointHoverRadius: 8
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                        labels: {
                            font: {
                                size: 14,
                                family: 'Inter',
                                weight: '600'
                            },
                            usePointStyle: true,
                            pointStyle: 'circle'
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        padding: 12,
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': ' + context.parsed.y.toLocaleString('cs-CZ') + ' KÄ';
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return value.toLocaleString('cs-CZ') + ' KÄ';
                            }
                        }
                    }
                },
                animation: {
                    duration: 2000,
                    easing: 'easeInOutQuart'
                }
            }
        });
    }

    // ========================================
    // PROGRESS BAR ANIMACE
    // ========================================
    const progressBars = document.querySelectorAll('[style*="width:"]');
    progressBars.forEach(bar => {
        const width = bar.style.width;
        bar.style.width = '0%';
        setTimeout(() => {
            bar.style.transition = 'width 1.5s ease-out';
            bar.style.width = width;
        }, 500);
    });

    // ========================================
    // HOVER EFEKTY NA KARTÃCH
    // ========================================
    document.querySelectorAll('.kpi-card, .card').forEach(card => {
        card.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-5px) scale(1.02)';
        });
        card.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0) scale(1)';
        });
    });
});
</script>
{% endblock %}
