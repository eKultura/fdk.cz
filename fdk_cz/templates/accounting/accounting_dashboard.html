{% extends "base.html" %}
{% block title %}ÃšÄetnictvÃ­ | FDK.cz{% endblock %}
{% block header_title %}ğŸ’° ÃšÄetnictvÃ­{% endblock %}
{% block header_subtitle %}SprÃ¡va faktur a penÄ›Å¾nÃ­ch denÃ­kÅ¯{% endblock %}

{% block context_breadcrumbs %}
<nav style="font-size: 0.875rem;">
  <span style="font-weight: 500; color: #1e293b;">ÃšÄetnictvÃ­</span>
  <span style="color: #9ca3af; margin: 0 0.5rem;">â†’</span>
  <span style="color: #1e293b; font-weight: 500;">Dashboard</span>
</nav>
{% endblock %}

{% block content %}

<div class="max-w-7xl mx-auto">
  <!-- Navigation Cards -->
  <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1rem;margin-bottom:1.5rem;">
    <a href="{% url 'create_invoice' %}" class="content-card hover:shadow-lg transition" style="text-decoration:none;cursor:pointer;">
      <div class="text-center p-4">
        <div style="font-size:2rem;margin-bottom:0.5rem;">ğŸ“„</div>
        <h3 class="font-semibold text-gray-800">Faktury</h3>
        <p class="text-sm text-gray-600 mt-1">SprÃ¡va faktur</p>
      </div>
    </a>
    <a href="{% url 'journal_ledger' %}" class="content-card hover:shadow-lg transition" style="text-decoration:none;cursor:pointer;">
      <div class="text-center p-4">
        <div style="font-size:2rem;margin-bottom:0.5rem;">ğŸ“š</div>
        <h3 class="font-semibold text-gray-800">ÃšÄetnÃ­ denÃ­k</h3>
        <p class="text-sm text-gray-600 mt-1">PodvojnÃ© ÃºÄetnictvÃ­</p>
      </div>
    </a>
    <a href="{% url 'balance_sheet_view' 'opening' %}" class="content-card hover:shadow-lg transition" style="text-decoration:none;cursor:pointer;">
      <div class="text-center p-4">
        <div style="font-size:2rem;margin-bottom:0.5rem;">ğŸ“Š</div>
        <h3 class="font-semibold text-gray-800">Rozvaha</h3>
        <p class="text-sm text-gray-600 mt-1">PoÄÃ¡teÄnÃ­ / KoneÄnÃ¡</p>
      </div>
    </a>
    <a href="{% url 'chart_of_accounts' %}" class="content-card hover:shadow-lg transition" style="text-decoration:none;cursor:pointer;">
      <div class="text-center p-4">
        <div style="font-size:2rem;margin-bottom:0.5rem;">ğŸ“‹</div>
        <h3 class="font-semibold text-gray-800">ÃšÄtovÃ¡ osnova</h3>
        <p class="text-sm text-gray-600 mt-1">SprÃ¡va ÃºÄtÅ¯</p>
      </div>
    </a>
  </div>

  <!-- Accounting Contexts (Organizace/OsobnÃ­) -->
  <div class="content-card mb-6">
    <div class="card-header" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;">
      <div>
        <h3 class="card-title" style="font-weight:600;font-size:1.1rem;">ğŸ¢ ÃšÄetnÃ­ kontexty</h3>
        {% if current_context %}
          {% if current_context.organization %}
          <p class="text-xs text-gray-500 mt-1">AktivnÃ­: <strong>{{ current_context.organization.name }}</strong> (Organizace)</p>
          {% else %}
          <p class="text-xs text-gray-500 mt-1">AktivnÃ­: <strong>OsobnÃ­ ÃºÄetnictvÃ­</strong></p>
          {% endif %}
        {% else %}
        <p class="text-xs text-orange-500 mt-1">NenÃ­ aktivnÃ­ Å¾Ã¡dnÃ½ kontext</p>
        {% endif %}
      </div>
      <a href="{% url 'select_accounting_context' %}" class="btn btn-primary text-sm">&#10133; NovÃ½ kontext</a>
    </div>
    {% if accounting_contexts %}
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:1rem;">
      {% for ctx in accounting_contexts %}
      <div style="padding:1rem;border:2px solid {% if current_context and ctx.context_id == current_context.context_id %}#3b82f6{% else %}#e5e7eb{% endif %};border-radius:8px;background:{% if current_context and ctx.context_id == current_context.context_id %}#eff6ff{% else %}#f9fafb{% endif %};transition:all 0.2s;">
        <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:0.5rem;">
          <h4 style="font-weight:600;color:#1f2937;">{{ ctx.name }}</h4>
          {% if current_context and ctx.context_id == current_context.context_id %}
          <span style="padding:0.25rem 0.5rem;background:#3b82f6;color:white;border-radius:4px;font-size:0.75rem;font-weight:600;">âœ“ AktivnÃ­</span>
          {% endif %}
        </div>
        <p style="font-size:0.875rem;color:#6b7280;margin-bottom:0.75rem;">
          {% if ctx.organization %}ğŸ¢ {{ ctx.organization.name }}{% else %}ğŸ‘¤ OsobnÃ­{% endif %}
        </p>
        <p style="font-size:0.75rem;color:#9ca3af;margin-bottom:0.75rem;">Rok: {{ ctx.fiscal_year }}</p>
        <div style="display:flex;gap:0.5rem;">
          {% if not current_context or ctx.context_id != current_context.context_id %}
          <a href="{% url 'set_accounting_context' ctx.context_id %}" class="btn btn-primary btn-sm" style="font-size:0.75rem;padding:0.375rem 0.75rem;">Aktivovat</a>
          {% endif %}
          <a href="{% url 'journal_ledger' %}" class="btn btn-outline btn-sm" style="font-size:0.75rem;padding:0.375rem 0.75rem;">DenÃ­k</a>
        </div>
      </div>
      {% endfor %}
    </div>
    {% else %}
    <div style="text-align:center;padding:2rem;background:#fef3c7;border:1px solid #fbbf24;border-radius:8px;">
      <p style="font-size:1rem;color:#92400e;margin-bottom:1rem;">ğŸ’¡ NemÃ¡te jeÅ¡tÄ› vytvoÅ™enÃ½ Å¾Ã¡dnÃ½ ÃºÄetnÃ­ kontext</p>
      <p style="font-size:0.875rem;color:#b45309;margin-bottom:1.5rem;">Pro pouÅ¾Ã­vÃ¡nÃ­ ÃºÄetnictvÃ­ musÃ­te nejprve vytvoÅ™it osobnÃ­ nebo organizaÄnÃ­ ÃºÄetnÃ­ kontext.</p>
      <a href="{% url 'select_accounting_context' %}" class="btn btn-primary">VytvoÅ™it prvnÃ­ kontext</a>
    </div>
    {% endif %}
  </div>

  <!-- Income Statement (VÃ½sledovka) -->
  <div class="content-card mb-6">
    <div class="card-header" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem;">
      <div>
        {% if current_context %}
          {% if current_context.organization %}
          <h3 class="text-xl font-semibold text-gray-800">ğŸ“ˆ VÃ½sledovka â€“ {{ current_context.organization.name }}</h3>
          <p class="text-sm text-gray-600 mt-1">ğŸ¢ Organizace Â· Rok: {{ current_context.fiscal_year }}</p>
          {% else %}
          <h3 class="text-xl font-semibold text-gray-800">ğŸ“ˆ VÃ½sledovka â€“ OsobnÃ­ ÃºÄetnictvÃ­</h3>
          <p class="text-sm text-gray-600 mt-1">ğŸ‘¤ OsobnÃ­ Â· Rok: {{ current_context.fiscal_year }}</p>
          {% endif %}
        {% else %}
        <h3 class="text-xl font-semibold text-gray-800">ğŸ“ˆ VÃ½sledovka</h3>
        <p class="text-sm text-orange-600 mt-1">âš ï¸ Nejprve vytvoÅ™te nebo aktivujte ÃºÄetnÃ­ kontext</p>
        {% endif %}
      </div>
      {% if current_context %}
      <a href="{% url 'balance_sheet_view' 'opening' %}" class="btn btn-outline text-sm">ğŸ“Š Rozvaha</a>
      {% endif %}
    </div>
    <div style="overflow-x:auto;margin-bottom:1.5rem;">
      <table style="width:100%;border-collapse:collapse;background:white;border:1px solid #e5e7eb;">
        <thead>
          <tr style="background:#f9fafb;border-bottom:2px solid #e5e7eb;">
            <th style="padding:1rem;text-align:left;font-weight:600;color:#4b5563;">PoloÅ¾ka</th>
            <th style="padding:1rem;text-align:right;font-weight:600;color:#4b5563;width:200px;">ÄŒÃ¡stka (KÄ)</th>
            <th style="padding:1rem;text-align:left;font-weight:600;color:#4b5563;width:120px;">ÃšÄty</th>
          </tr>
        </thead>
        <tbody>
          <!-- Revenues Section -->
          <tr style="background:#f0fdf4;border-bottom:1px solid #86efac;">
            <td style="padding:0.75rem 1rem;font-weight:600;color:#166534;">ğŸ’° VÃ½nosy celkem</td>
            <td style="padding:0.75rem 1rem;text-align:right;font-weight:700;color:#15803d;font-size:1.1rem;">{{ total_revenues|default:0|floatformat:2 }}</td>
            <td style="padding:0.75rem 1rem;font-size:0.875rem;color:#16a34a;">6xx</td>
          </tr>

          <!-- Expenses Section -->
          <tr style="background:#fef2f2;border-bottom:1px solid #fca5a5;">
            <td style="padding:0.75rem 1rem;font-weight:600;color:#991b1b;">ğŸ’¸ NÃ¡klady celkem</td>
            <td style="padding:0.75rem 1rem;text-align:right;font-weight:700;color:#dc2626;font-size:1.1rem;">{{ total_expenses|default:0|floatformat:2 }}</td>
            <td style="padding:0.75rem 1rem;font-size:0.875rem;color:#ef4444;">5xx</td>
          </tr>
        </tbody>
        <tfoot>
          <tr style="background:#f3f4f6;border-top:2px solid #d1d5db;">
            <td style="padding:1rem;font-weight:700;color:#1f2937;font-size:1.125rem;">
              {% if profit >= 0 %}
                ğŸ“Š HospodÃ¡Å™skÃ½ vÃ½sledek (ZISK)
              {% else %}
                ğŸ“‰ HospodÃ¡Å™skÃ½ vÃ½sledek (ZTRÃTA)
              {% endif %}
            </td>
            <td style="padding:1rem;text-align:right;font-weight:700;font-size:1.25rem;{% if profit >= 0 %}color:#1d4ed8;{% else %}color:#ea580c;{% endif %}">
              {{ profit|default:0|floatformat:2 }}
            </td>
            <td style="padding:1rem;font-size:0.875rem;{% if profit >= 0 %}color:#3b82f6;{% else %}color:#f97316;{% endif %}">
              VÃ½nosy - NÃ¡klady
            </td>
          </tr>
        </tfoot>
      </table>
    </div>

    <!-- Summary Cards - Quick Overview -->
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1rem;">
      <div style="padding:1rem;background:#f0fdf4;border:1px solid #86efac;border-radius:8px;">
        <h4 style="font-size:0.875rem;font-weight:600;color:#166534;margin-bottom:0.5rem;">ğŸ’° VÃ½nosy</h4>
        <p style="font-size:1.5rem;font-weight:700;color:#15803d;">{{ total_revenues|default:0|floatformat:2 }} KÄ</p>
      </div>
      <div style="padding:1rem;background:#fef2f2;border:1px solid #fca5a5;border-radius:8px;">
        <h4 style="font-size:0.875rem;font-weight:600;color:#991b1b;margin-bottom:0.5rem;">ğŸ’¸ NÃ¡klady</h4>
        <p style="font-size:1.5rem;font-weight:700;color:#dc2626;">{{ total_expenses|default:0|floatformat:2 }} KÄ</p>
      </div>
      <div style="padding:1rem;{% if profit >= 0 %}background:#eff6ff;border:1px solid #93c5fd;{% else %}background:#fff7ed;border:1px solid #fdba74;{% endif %}border-radius:8px;">
        <h4 style="font-size:0.875rem;font-weight:600;{% if profit >= 0 %}color:#1e40af;{% else %}color:#9a3412;{% endif %}margin-bottom:0.5rem;">
          {% if profit >= 0 %}ğŸ“Š Zisk{% else %}ğŸ“‰ ZtrÃ¡ta{% endif %}
        </h4>
        <p style="font-size:1.5rem;font-weight:700;{% if profit >= 0 %}color:#1d4ed8;{% else %}color:#ea580c;{% endif %}">
          {{ profit|default:0|floatformat:2 }} KÄ
        </p>
      </div>
    </div>
  </div>

  <!-- Recent Journal Entries -->
  {% if recent_journal_entries %}
  <div class="content-card mb-6">
    <div class="card-header" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;">
      <h3 class="text-xl font-semibold text-gray-800">ğŸ“š PoslednÃ­ zÃ¡znamy v denÃ­ku</h3>
      <a href="{% url 'journal_ledger' %}" class="btn btn-outline text-sm">CelÃ½ denÃ­k â†’</a>
    </div>
    <div style="overflow-x:auto;">
      <table style="width:100%;border-collapse:collapse;background:white;border:1px solid #e5e7eb;">
        <thead>
          <tr style="background:#f9fafb;border-bottom:2px solid #e5e7eb;">
            <th style="padding:0.75rem;text-align:left;font-weight:600;color:#4b5563;">Datum</th>
            <th style="padding:0.75rem;text-align:left;font-weight:600;color:#4b5563;">Popis</th>
            <th style="padding:0.75rem;text-align:right;font-weight:600;color:#4b5563;width:120px;">MD</th>
            <th style="padding:0.75rem;text-align:right;font-weight:600;color:#4b5563;width:120px;">D</th>
          </tr>
        </thead>
        <tbody>
          {% for entry in recent_journal_entries %}
          <tr style="border-bottom:1px solid #e5e7eb;">
            <td style="padding:0.75rem;color:#1f2937;">{{ entry.date|date:"d.m.Y" }}</td>
            <td style="padding:0.75rem;color:#374151;">
              <strong>{{ entry.description }}</strong>
              {% if entry.lines.count > 0 %}
              <div style="font-size:0.75rem;color:#6b7280;margin-top:0.25rem;">
                {% for line in entry.lines.all|slice:":2" %}
                  {{ line.account.account_number }} {{ line.account.name }}{% if not forloop.last %}, {% endif %}
                {% endfor %}
                {% if entry.lines.count > 2 %}... (+{{ entry.lines.count|add:"-2" }}){% endif %}
              </div>
              {% endif %}
            </td>
            <td style="padding:0.75rem;text-align:right;font-weight:600;color:#1d4ed8;">
              {{ entry.total_debit|floatformat:2 }} KÄ
            </td>
            <td style="padding:0.75rem;text-align:right;font-weight:600;color:#15803d;">
              {{ entry.total_credit|floatformat:2 }} KÄ
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  {% endif %}

  <!-- Statistics -->
  <div class="stats-grid mb-6">
    <div class="stat-card">
      <div style="display: flex; justify-content: space-between; align-items: flex-start;">
        <div>
          <div class="stat-title">Celkem faktur</div>
          <div class="stat-value">{{ total_invoices|default:invoices|length|default:0 }}</div>
        </div>
        <div class="stat-icon primary">ğŸ“„</div>
      </div>
    </div>
    <div class="stat-card">
      <div style="display: flex; justify-content: space-between; align-items: flex-start;">
        <div>
          <div class="stat-title">NevyÅ™Ã­zenÃ½ch</div>
          <div class="stat-value">{{ pending_invoices|default:0 }}</div>
        </div>
        <div class="stat-icon warning">â³</div>
      </div>
    </div>
    <div class="stat-card">
      <div style="display: flex; justify-content: space-between; align-items: flex-start;">
        <div>
          <div class="stat-title">ZaplacenÃ½ch</div>
          <div class="stat-value">{{ paid_invoices|default:0 }}</div>
        </div>
        <div class="stat-icon success">âœ…</div>
      </div>
    </div>
  </div>

  <!-- Recent Invoices -->
  <div class="content-card">
    <div class="card-header" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;">
      <h3 class="card-title" style="font-weight:600;font-size:1.1rem;">ğŸ“„ NedÃ¡vnÃ© faktury</h3>
      <div class="flex gap-2">
        <a href="{% url 'create_invoice' %}" class="btn btn-primary text-sm">&#10133; NovÃ¡ faktura</a>
        <a href="{% url 'list_invoices' %}" class="btn btn-outline text-sm">VÅ¡echny faktury</a>
      </div>
    </div>
    {% if invoices %}
    <div class="overflow-x-auto">
      <table class="data-table" style="width:100%;border-collapse:collapse;">
        <thead style="background:#f9fafb;">
          <tr>
            <th class="px-4 py-2 text-left text-gray-600 font-semibold">ÄŒÃ­slo faktury</th>
            <th class="px-4 py-2 text-left text-gray-600 font-semibold hidden md:table-cell">Datum vystavenÃ­</th>
            <th class="px-4 py-2 text-left text-gray-600 font-semibold hidden md:table-cell">Datum splatnosti</th>
            <th class="px-4 py-2 text-left text-gray-600 font-semibold hidden lg:table-cell">PlÃ¡tce</th>
            <th class="px-4 py-2 text-right text-gray-600 font-semibold">ÄŒÃ¡stka</th>
            <th class="px-4 py-2 text-left text-gray-600 font-semibold">Stav</th>
            <th class="px-4 py-2 text-center text-gray-600 font-semibold w-1/6">Akce</th>
          </tr>
        </thead>
        <tbody>
          {% for invoice in invoices %}
          <tr style="border-bottom:1px solid #e5e7eb;" class="hover:bg-gray-50 transition">
            <td class="px-4 py-2 text-gray-800 font-medium">{{ invoice.invoice_number }}</td>
            <td class="px-4 py-2 text-gray-500 hidden md:table-cell">{{ invoice.issue_date|date:"d.m.Y"|default:"â€“" }}</td>
            <td class="px-4 py-2 text-gray-500 hidden md:table-cell">{{ invoice.due_date|date:"d.m.Y"|default:"â€“" }}</td>
            <td class="px-4 py-2 text-gray-500 hidden lg:table-cell">{{ invoice.company.name|default:"â€“" }}</td>
            <td class="px-4 py-2 text-right font-semibold text-gray-800">{{ invoice.total_amount|default:"â€“" }} KÄ</td>
            <td class="px-4 py-2">
              {% if invoice.status == 'paid' %}
                <span class="px-2 py-1 bg-green-100 text-green-700 rounded text-sm">âœ“ Zaplaceno</span>
              {% elif invoice.status == 'pending' %}
                <span class="px-2 py-1 bg-yellow-100 text-yellow-700 rounded text-sm">â³ ÄŒekÃ¡</span>
              {% elif invoice.status == 'overdue' %}
                <span class="px-2 py-1 bg-red-100 text-red-700 rounded text-sm">âš ï¸ Po splatnosti</span>
              {% else %}
                <span class="px-2 py-1 bg-gray-100 text-gray-700 rounded text-sm">{{ invoice.get_status_display }}</span>
              {% endif %}
            </td>
            <td class="px-4 py-2 text-center">
              <a href="{% url 'detail_invoice' invoice.id %}" class="text-blue-600 hover:text-blue-800 text-sm mr-2">Detail</a>
              <a href="{% url 'edit_invoice' invoice.id %}" class="text-yellow-600 hover:text-yellow-800 text-sm">Upravit</a>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <div class="empty-state" style="text-align:center;padding:2rem;color:#6b7280;">
      <div style="font-size:2rem;">ğŸ“„</div>
      <p style="margin-top:0.5rem;">ZatÃ­m nemÃ¡te vytvoÅ™enÃ© Å¾Ã¡dnÃ© faktury.</p>
      <a href="{% url 'create_invoice' %}" class="btn btn-outline" style="margin-top:1rem;">â• VytvoÅ™it prvnÃ­ fakturu</a>
    </div>
    {% endif %}
  </div>
</div>
{% endblock %}
