{% extends "base.html" %}
{% block title %}{{ organization.name }} | FDK.cz{% endblock %}
{% block header_title %}üè¢ {{ organization.name }}{% endblock %}
{% block header_subtitle %}IƒåO: {{ organization.ico }} ¬∑ Vytvo≈ôeno: {{ organization.created_at|date:"d.m.Y" }}{% endblock %}

{% block context_breadcrumbs %}
<a href="{% url 'organization_dashboard' %}" class="breadcrumb-link">Organizace</a>
<span class="breadcrumb-sep">‚Üí</span>
<span style="font-weight: 600; color: #1e293b;">{{ organization.name|safe }}</span>
{% endblock %}

{% block content %}

<div style="max-width: 1200px; margin: 0 auto;">

  <!-- Back Button & Actions -->
  <div style="margin-bottom: 2rem; display: flex; justify-content: space-between; align-items: center;">
    <a href="{% url 'organization_dashboard' %}" class="btn btn-outline">
      ‚Üê Zpƒõt na p≈ôehled organizac√≠
    </a>
    {% if is_admin %}
    <a href="{% url 'organization_iam' organization.organization_id %}" class="btn btn-primary">
      üîê IAM Spr√°va
    </a>
    {% endif %}
  </div>

  <!-- Organization Info -->
  <div class="content-card" style="margin-bottom: 2rem;">
    <h3 style="font-size: 1.25rem; font-weight: 600; color: #1e293b; margin-bottom: 1rem;">
      üìã Informace o organizaci
    </h3>
    <div class="data-table-simple">
      <div class="data-row">
        <span class="data-label">N√°zev</span>
        <span class="data-value">{{ organization.name }}</span>
      </div>
      <div class="data-row">
        <span class="data-label">IƒåO</span>
        <span class="data-value">{{ organization.ico }}</span>
      </div>
      <div class="data-row">
        <span class="data-label">Vlastn√≠k</span>
        <span class="data-value">{{ organization.created_by.username }}</span>
      </div>
      <div class="data-row">
        <span class="data-label">Datum vytvo≈ôen√≠</span>
        <span class="data-value">{{ organization.created_at|date:"d.m.Y H:i" }}</span>
      </div>
      <div class="data-row">
        <span class="data-label">Poƒçet ƒçlen≈Ø</span>
        <span class="data-value">{{ memberships.count }}</span>
      </div>
    </div>
  </div>

  <!-- Members -->
  <div class="content-card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
      <h3 style="font-size: 1.25rem; font-weight: 600; color: #1e293b;">
        üë• ƒålenov√© organizace
      </h3>
      {% if is_admin %}
      <button onclick="document.getElementById('addMemberForm').style.display='block'" class="btn btn-primary btn-sm">
        ‚ûï P≈ôidat ƒçlena
      </button>
      {% endif %}
    </div>

    <!-- Add Member Form (Hidden by default) -->
    {% if is_admin %}
    <div id="addMemberForm" style="display: none; background: #f8fafc; border: 2px solid #3b82f6; border-radius: 8px; padding: 1.5rem; margin-bottom: 1.5rem;">
      <h4 style="font-size: 1rem; font-weight: 600; color: #1e293b; margin-bottom: 1rem;">P≈ôidat nov√©ho ƒçlena</h4>
      <form method="POST" action="{% url 'add_organization_member' organization.organization_id %}" id="addMemberFormElement">
        {% csrf_token %}
        <div style="display: grid; gap: 1rem; margin-bottom: 1rem;">
          <div class="form-group">
            <label for="id_user_search" class="form-label">Vyhledat u≈æivatele</label>
            <input
              type="text"
              id="id_user_search"
              class="form-control"
              placeholder="Zaƒçnƒõte ps√°t jm√©no nebo email..."
              autocomplete="off"
            >
            <input type="hidden" id="id_user_id" name="user_id" required>
            <div id="searchResults" style="display: none; position: absolute; z-index: 1000; background: white; border: 1px solid #e2e8f0; border-radius: 8px; max-height: 300px; overflow-y: auto; box-shadow: 0 4px 6px rgba(0,0,0,0.1); width: calc(100% - 3rem);"></div>
            <div class="form-help" id="selectedUserInfo" style="display: none; margin-top: 0.5rem; padding: 0.5rem; background: #dbeafe; border-radius: 4px; color: #1e40af;"></div>
          </div>
          <div class="form-group">
            <label for="id_role" class="form-label">Role</label>
            <select id="id_role" name="role" class="form-control">
              <option value="member">ƒålen</option>
              <option value="admin">Admin</option>
              <option value="viewer">Pozorovatel</option>
            </select>
          </div>
        </div>
        <div style="display: flex; gap: 0.75rem;">
          <button type="submit" class="btn btn-primary btn-sm" id="submitMemberBtn" disabled>P≈ôidat</button>
          <button type="button" onclick="cancelAddMember()" class="btn btn-outline btn-sm">Zru≈°it</button>
        </div>
      </form>
    </div>
    {% endif %}

    <!-- Members List -->
    <table class="data-table">
      <thead>
        <tr>
          <th>U≈æivatel</th>
          <th>Email</th>
          <th>Role</th>
          <th>Datum p≈ôid√°n√≠</th>
          {% if is_admin %}<th class="text-right">Akce</th>{% endif %}
        </tr>
      </thead>
      <tbody>
        {% for membership in memberships %}
        <tr>
          <td>
            <strong>{{ membership.user.username }}</strong>
            {% if membership.user == organization.created_by %}
              <span style="background: #fef3c7; color: #92400e; padding: 2px 8px; border-radius: 12px; font-size: 0.75rem; margin-left: 0.5rem;">Vlastn√≠k</span>
            {% endif %}
          </td>
          <td>{{ membership.user.email|default:"‚Äî" }}</td>
          <td>
            <span style="padding: 4px 12px; border-radius: 12px; font-size: 0.875rem; font-weight: 500;
              {% if membership.role == 'admin' %}background: #dbeafe; color: #1e40af;
              {% elif membership.role == 'member' %}background: #f0fdf4; color: #166534;
              {% else %}background: #f8fafc; color: #64748b;{% endif %}">
              {{ membership.get_role_display }}
            </span>
          </td>
          <td>{{ membership.joined_at|date:"d.m.Y" }}</td>
          {% if is_admin %}
          <td class="text-right">
            {% if membership.user != organization.created_by %}
            <a href="{% url 'remove_organization_member' organization.organization_id membership.user.id %}"
               onclick="return confirm('Opravdu chcete odebrat tohoto ƒçlena?')"
               class="btn btn-sm btn-outline danger">
              üóëÔ∏è Odebrat
            </a>
            {% else %}
            <span style="color: #94a3b8; font-size: 0.875rem;">Nelze odebrat</span>
            {% endif %}
          </td>
          {% endif %}
        </tr>
        {% empty %}
        <tr><td colspan="{% if is_admin %}5{% else %}4{% endif %}" class="data-table-empty">≈Ω√°dn√≠ ƒçlenov√©</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

</div>

<style>
  .data-table-simple {
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    overflow: hidden;
  }

  .data-row {
    display: flex;
    justify-content: space-between;
    padding: 0.75rem 1rem;
    border-bottom: 1px solid #f1f5f9;
  }

  .data-row:last-child {
    border-bottom: none;
  }

  .data-row:hover {
    background: #f8fafc;
  }

  .data-label {
    font-weight: 600;
    color: #475569;
  }

  .data-value {
    color: #1e293b;
  }

  .search-result-item {
    padding: 0.75rem 1rem;
    cursor: pointer;
    border-bottom: 1px solid #f1f5f9;
    transition: background 0.15s;
  }

  .search-result-item:hover {
    background: #f8fafc;
  }

  .search-result-item:last-child {
    border-bottom: none;
  }
</style>

<script>
let searchTimeout = null;
let selectedUserId = null;

function cancelAddMember() {
  document.getElementById('addMemberForm').style.display = 'none';
  document.getElementById('id_user_search').value = '';
  document.getElementById('id_user_id').value = '';
  document.getElementById('searchResults').style.display = 'none';
  document.getElementById('selectedUserInfo').style.display = 'none';
  document.getElementById('submitMemberBtn').disabled = true;
  selectedUserId = null;
}

document.getElementById('id_user_search')?.addEventListener('input', function(e) {
  const query = e.target.value.trim();

  if (query.length < 2) {
    document.getElementById('searchResults').style.display = 'none';
    return;
  }

  // Debounce
  clearTimeout(searchTimeout);
  searchTimeout = setTimeout(() => {
    fetch(`/api/search-users/?q=${encodeURIComponent(query)}`)
      .then(response => response.json())
      .then(data => {
        const resultsDiv = document.getElementById('searchResults');

        if (data.users.length === 0) {
          resultsDiv.innerHTML = '<div style="padding: 1rem; text-align: center; color: #64748b;">≈Ω√°dn√≠ u≈æivatel√© nenalezeni</div>';
          resultsDiv.style.display = 'block';
          return;
        }

        resultsDiv.innerHTML = data.users.map(user => `
          <div class="search-result-item" onclick="selectUser(${user.id}, '${user.full_name}', '${user.email}')">
            <div style="font-weight: 600; color: #1e293b;">${user.full_name}</div>
            <div style="font-size: 0.875rem; color: #64748b;">${user.email}</div>
          </div>
        `).join('');

        resultsDiv.style.display = 'block';
      })
      .catch(error => {
        console.error('Error searching users:', error);
      });
  }, 300);
});

function selectUser(userId, fullName, email) {
  selectedUserId = userId;
  document.getElementById('id_user_id').value = userId;
  document.getElementById('id_user_search').value = fullName;
  document.getElementById('searchResults').style.display = 'none';

  const infoDiv = document.getElementById('selectedUserInfo');
  infoDiv.innerHTML = `‚úì Vybr√°n: <strong>${fullName}</strong> (${email})`;
  infoDiv.style.display = 'block';

  document.getElementById('submitMemberBtn').disabled = false;
}

// Close search results when clicking outside
document.addEventListener('click', function(e) {
  const searchInput = document.getElementById('id_user_search');
  const searchResults = document.getElementById('searchResults');

  if (searchInput && searchResults && !searchInput.contains(e.target) && !searchResults.contains(e.target)) {
    searchResults.style.display = 'none';
  }
});
</script>
{% endblock %}
