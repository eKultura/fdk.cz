{% extends "base.html" %}
{% block title %}IAM Spr√°va - {{ organization.name }} | FDK.cz{% endblock %}
{% block header_title %}üîê IAM Spr√°va: {{ organization.name }}{% endblock %}
{% block header_subtitle %}Spr√°va rol√≠ a opr√°vnƒõn√≠ organizace{% endblock %}

{% block context_breadcrumbs %}
<a href="{% url 'organization_dashboard' %}" class="breadcrumb-link">Organizace</a>
<span class="breadcrumb-sep">‚Üí</span>
<a href="{% url 'organization_detail' organization.organization_id %}" class="breadcrumb-link">{{ organization.name|safe }}</a>
<span class="breadcrumb-sep">‚Üí</span>
<span style="font-weight: 600; color: #1e293b;">IAM Spr√°va</span>
{% endblock %}

{% block content %}

<div style="max-width: 1400px; margin: 0 auto;">

  <!-- Back Button -->
  <div style="margin-bottom: 2rem;">
    <a href="{% url 'organization_detail' organization.organization_id %}" class="btn btn-outline">
      ‚Üê Zpƒõt na detail organizace
    </a>
  </div>

  <!-- Info Box -->
  <div class="content-card" style="margin-bottom: 2rem; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border: 2px solid #f59e0b;">
    <div style="display: flex; align-items: start; gap: 1rem;">
      <div style="font-size: 2rem;">‚ÑπÔ∏è</div>
      <div>
        <h3 style="font-size: 1rem; font-weight: 600; color: #92400e; margin-bottom: 0.5rem;">Co je IAM?</h3>
        <p style="color: #78350f; font-size: 0.875rem; margin: 0;">
          IAM (Identity and Access Management) umo≈æ≈àuje ≈ô√≠dit, kdo m√° p≈ô√≠stup k jak√Ωm zdroj≈Øm v organizaci.
          M≈Ø≈æete p≈ôi≈ôazovat role ƒçlen≈Øm a spravovat jejich opr√°vnƒõn√≠ na √∫rovni organizace i jednotliv√Ωch modul≈Ø.
        </p>
      </div>
    </div>
  </div>

  <!-- ƒålenov√© a jejich role -->
  <div class="content-card" style="margin-bottom: 2rem;">
    <h3 style="font-size: 1.25rem; font-weight: 600; color: #1e293b; margin-bottom: 1.5rem;">
      üë• ƒålenov√© a z√°kladn√≠ role
    </h3>

    <table class="data-table">
      <thead>
        <tr>
          <th>U≈æivatel</th>
          <th>Email</th>
          <th>Z√°kladn√≠ role</th>
          <th>Organizaƒçn√≠ role</th>
          <th>Modulov√© role</th>
          {% if is_admin %}<th class="text-right">Akce</th>{% endif %}
        </tr>
      </thead>
      <tbody>
        {% for membership in memberships %}
        <tr>
          <td>
            <strong>{{ membership.user.username }}</strong>
            {% if membership.user == organization.created_by %}
              <span style="background: #fef3c7; color: #92400e; padding: 2px 8px; border-radius: 12px; font-size: 0.75rem; margin-left: 0.5rem;">Vlastn√≠k</span>
            {% endif %}
          </td>
          <td>{{ membership.user.email|default:"‚Äî" }}</td>
          <td>
            {% if is_admin and membership.user != organization.created_by %}
            <form method="POST" action="{% url 'change_member_role' organization.organization_id membership.user.id %}" style="display: inline;">
              {% csrf_token %}
              <select name="role" onchange="this.form.submit()" class="form-control" style="display: inline-block; width: auto; padding: 0.25rem 0.5rem; font-size: 0.875rem;">
                <option value="admin" {% if membership.role == 'admin' %}selected{% endif %}>Admin</option>
                <option value="member" {% if membership.role == 'member' %}selected{% endif %}>ƒålen</option>
                <option value="viewer" {% if membership.role == 'viewer' %}selected{% endif %}>Pozorovatel</option>
              </select>
            </form>
            {% else %}
            <span style="padding: 4px 12px; border-radius: 12px; font-size: 0.875rem; font-weight: 500;
              {% if membership.role == 'admin' %}background: #dbeafe; color: #1e40af;
              {% elif membership.role == 'member' %}background: #f0fdf4; color: #166534;
              {% else %}background: #f8fafc; color: #64748b;{% endif %}">
              {{ membership.get_role_display }}
            </span>
            {% endif %}
          </td>
          <td>
            {% with org_roles=membership.organization_roles.all %}
              {% if org_roles %}
                {% for role in org_roles %}
                  <span style="background: #e0e7ff; color: #3730a3; padding: 2px 8px; border-radius: 12px; font-size: 0.75rem; margin-right: 0.25rem;">
                    {{ role.role_type }}
                  </span>
                {% endfor %}
              {% else %}
                <span style="color: #94a3b8; font-size: 0.875rem;">‚Äî</span>
              {% endif %}
            {% endwith %}
          </td>
          <td>
            {% with mod_roles=membership.module_roles.all %}
              {% if mod_roles %}
                {% for role in mod_roles %}
                  <span style="background: #fce7f3; color: #831843; padding: 2px 8px; border-radius: 12px; font-size: 0.75rem; margin-right: 0.25rem;">
                    {{ role.module.name }}: {{ role.role_type }}
                  </span>
                {% endfor %}
              {% else %}
                <span style="color: #94a3b8; font-size: 0.875rem;">‚Äî</span>
              {% endif %}
            {% endwith %}
          </td>
          {% if is_admin %}
          <td class="text-right">
            {% if membership.user != organization.created_by %}
              <button class="btn btn-sm btn-outline" onclick="alert('Spr√°va detailn√≠ch rol√≠ bude p≈ôid√°na v dal≈°√≠ verzi')">
                ‚öôÔ∏è Spravovat
              </button>
            {% else %}
              <span style="color: #94a3b8; font-size: 0.875rem;">Vlastn√≠k</span>
            {% endif %}
          </td>
          {% endif %}
        </tr>
        {% empty %}
        <tr><td colspan="{% if is_admin %}6{% else %}5{% endif %}" class="data-table-empty">≈Ω√°dn√≠ ƒçlenov√©</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Vysvƒõtlen√≠ z√°kladn√≠ch rol√≠ -->
  <div class="content-card" style="margin-bottom: 2rem;">
    <h3 style="font-size: 1.25rem; font-weight: 600; color: #1e293b; margin-bottom: 1rem;">
      üìã Z√°kladn√≠ role v organizaci
    </h3>

    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem;">
      <div style="padding: 1rem; border: 2px solid #3b82f6; border-radius: 8px; background: #eff6ff;">
        <h4 style="font-weight: 600; color: #1e40af; margin-bottom: 0.5rem;">üëë Admin</h4>
        <p style="font-size: 0.875rem; color: #1e293b; margin: 0;">
          Pln√° spr√°va organizace vƒçetnƒõ p≈ôid√°v√°n√≠/odeb√≠r√°n√≠ ƒçlen≈Ø, zmƒõny rol√≠ a spr√°vy IAM.
        </p>
      </div>

      <div style="padding: 1rem; border: 2px solid #10b981; border-radius: 8px; background: #f0fdf4;">
        <h4 style="font-weight: 600; color: #166534; margin-bottom: 0.5rem;">üë§ ƒålen</h4>
        <p style="font-size: 0.875rem; color: #1e293b; margin: 0;">
          Standardn√≠ ƒçlen s p≈ô√≠stupem k projekt≈Øm a modul≈Øm organizace podle p≈ôi≈ôazen√Ωch modulov√Ωch rol√≠.
        </p>
      </div>

      <div style="padding: 1rem; border: 2px solid #64748b; border-radius: 8px; background: #f8fafc;">
        <h4 style="font-weight: 600; color: #475569; margin-bottom: 0.5rem;">üëÅÔ∏è Pozorovatel</h4>
        <p style="font-size: 0.875rem; color: #1e293b; margin: 0;">
          Pouze ƒçten√≠ - m≈Ø≈æe zobrazit informace, ale nem≈Ø≈æe prov√°dƒõt zmƒõny.
        </p>
      </div>
    </div>
  </div>

  <!-- Organizaƒçn√≠ role (pokud existuj√≠) -->
  {% if org_roles %}
  <div class="content-card" style="margin-bottom: 2rem;">
    <h3 style="font-size: 1.25rem; font-weight: 600; color: #1e293b; margin-bottom: 1rem;">
      üéØ Organizaƒçn√≠ role
    </h3>

    <table class="data-table">
      <thead>
        <tr>
          <th>U≈æivatel</th>
          <th>Typ role</th>
          <th>Opr√°vnƒõn√≠</th>
          <th>P≈ôi≈ôazeno</th>
        </tr>
      </thead>
      <tbody>
        {% for role in org_roles %}
        <tr>
          <td><strong>{{ role.membership.user.username }}</strong></td>
          <td>
            <span style="background: #e0e7ff; color: #3730a3; padding: 4px 12px; border-radius: 12px; font-size: 0.875rem; font-weight: 500;">
              {{ role.role_type }}
            </span>
          </td>
          <td>
            {% for perm in role.permissions.all %}
              <span style="background: #f0fdf4; color: #166534; padding: 2px 8px; border-radius: 12px; font-size: 0.75rem; margin-right: 0.25rem;">
                {{ perm.name }}
              </span>
            {% empty %}
              <span style="color: #94a3b8; font-size: 0.875rem;">≈Ω√°dn√° opr√°vnƒõn√≠</span>
            {% endfor %}
          </td>
          <td style="font-size: 0.875rem; color: #64748b;">{{ role.assigned_at|date:"d.m.Y H:i" }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% endif %}

  <!-- Modulov√© role (pokud existuj√≠) -->
  {% if module_roles %}
  <div class="content-card">
    <h3 style="font-size: 1.25rem; font-weight: 600; color: #1e293b; margin-bottom: 1rem;">
      üì¶ Modulov√© role
    </h3>

    <table class="data-table">
      <thead>
        <tr>
          <th>U≈æivatel</th>
          <th>Modul</th>
          <th>Typ role</th>
          <th>Opr√°vnƒõn√≠</th>
          <th>P≈ôi≈ôazeno</th>
        </tr>
      </thead>
      <tbody>
        {% for role in module_roles %}
        <tr>
          <td><strong>{{ role.membership.user.username }}</strong></td>
          <td>
            <span style="background: #f3f4f6; color: #1e293b; padding: 4px 8px; border-radius: 6px; font-size: 0.875rem;">
              {{ role.module.display_name }}
            </span>
          </td>
          <td>
            <span style="background: #fce7f3; color: #831843; padding: 4px 12px; border-radius: 12px; font-size: 0.875rem; font-weight: 500;">
              {{ role.role_type }}
            </span>
          </td>
          <td>
            {% for perm in role.permissions.all %}
              <span style="background: #f0fdf4; color: #166534; padding: 2px 8px; border-radius: 12px; font-size: 0.75rem; margin-right: 0.25rem;">
                {{ perm.name }}
              </span>
            {% empty %}
              <span style="color: #94a3b8; font-size: 0.875rem;">≈Ω√°dn√° opr√°vnƒõn√≠</span>
            {% endfor %}
          </td>
          <td style="font-size: 0.875rem; color: #64748b;">{{ role.assigned_at|date:"d.m.Y H:i" }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% endif %}

</div>

{% endblock %}
