{% extends "base.html" %}
{% block title %}IAM SprÃ¡va - {{ organization.name }} | FDK.cz{% endblock %}
{% block header_title %}ğŸ” IAM SprÃ¡va: {{ organization.name }}{% endblock %}
{% block header_subtitle %}SprÃ¡va rolÃ­ a oprÃ¡vnÄ›nÃ­ organizace{% endblock %}

{% block context_breadcrumbs %}
<a href="{% url 'organization_dashboard' %}" class="breadcrumb-link">Organizace</a>
<span class="breadcrumb-sep">â†’</span>
<a href="{% url 'organization_detail' organization.organization_id %}" class="breadcrumb-link">{{ organization.name|safe }}</a>
<span class="breadcrumb-sep">â†’</span>
<span style="font-weight: 600; color: #1e293b;">IAM SprÃ¡va</span>
{% endblock %}

{% block content %}

<div style="max-width: 1400px; margin: 0 auto;">

  <!-- Back Button -->
  <div style="margin-bottom: 2rem;">
    <a href="{% url 'organization_detail' organization.organization_id %}" class="btn btn-outline">
      â† ZpÄ›t na detail organizace
    </a>
  </div>

  <!-- Info Box -->
  <div class="content-card" style="margin-bottom: 2rem; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border: 2px solid #f59e0b;">
    <div style="display: flex; align-items: start; gap: 1rem;">
      <div style="font-size: 2rem;">â„¹ï¸</div>
      <div>
        <h3 style="font-size: 1rem; font-weight: 600; color: #92400e; margin-bottom: 0.5rem;">Co je IAM?</h3>
        <p style="color: #78350f; font-size: 0.875rem; margin: 0;">
          IAM (Identity and Access Management) umoÅ¾Åˆuje Å™Ã­dit, kdo mÃ¡ pÅ™Ã­stup k jakÃ½m zdrojÅ¯m v organizaci.
          MÅ¯Å¾ete pÅ™iÅ™azovat role ÄlenÅ¯m a spravovat jejich oprÃ¡vnÄ›nÃ­ na Ãºrovni organizace i jednotlivÃ½ch modulÅ¯.
        </p>
      </div>
    </div>
  </div>

  <!-- ÄŒlenovÃ© a jejich role -->
  <div class="content-card" style="margin-bottom: 2rem;">
    <h3 style="font-size: 1.25rem; font-weight: 600; color: #1e293b; margin-bottom: 1.5rem;">
      ğŸ‘¥ ÄŒlenovÃ© a zÃ¡kladnÃ­ role
    </h3>

    <table class="data-table">
      <thead>
        <tr>
          <th>UÅ¾ivatel</th>
          <th>Email</th>
          <th>ZÃ¡kladnÃ­ role</th>
          {% if is_admin %}<th class="text-right">Akce</th>{% endif %}
        </tr>
      </thead>
      <tbody>
        {% for membership in memberships %}
        <tr>
          <td>
            <strong>{{ membership.user.username }}</strong>
            {% if membership.user == organization.created_by %}
              <span style="background: #fef3c7; color: #92400e; padding: 2px 8px; border-radius: 12px; font-size: 0.75rem; margin-left: 0.5rem;">VlastnÃ­k</span>
            {% endif %}
          </td>
          <td>{{ membership.user.email|default:"â€”" }}</td>
          <td>
            {% if is_admin and membership.user != organization.created_by %}
            <form method="POST" action="{% url 'change_member_role' organization.organization_id membership.user.id %}" style="display: inline;">
              {% csrf_token %}
              <select name="role" onchange="this.form.submit()" class="form-control" style="display: inline-block; width: auto; padding: 0.25rem 0.5rem; font-size: 0.875rem;">
                <option value="organization_admin" {% if membership.role.role_name == 'organization_admin' %}selected{% endif %}>Admin</option>
                <option value="organization_member" {% if membership.role.role_name == 'organization_member' %}selected{% endif %}>ÄŒlen</option>
                <option value="organization_viewer" {% if membership.role.role_name == 'organization_viewer' %}selected{% endif %}>Pozorovatel</option>
              </select>
            </form>
            {% else %}
            <span style="padding: 4px 12px; border-radius: 12px; font-size: 0.875rem; font-weight: 500;
              {% if membership.role.role_name == 'organization_admin' %}background: #dbeafe; color: #1e40af;
              {% elif membership.role.role_name == 'organization_member' %}background: #f0fdf4; color: #166534;
              {% else %}background: #f8fafc; color: #64748b;{% endif %}">
              {{ membership.role.role_name|title }}
            </span>
            {% endif %}
          </td>
          {% if is_admin %}
          <td class="text-right">
            {% if membership.user != organization.created_by %}
              <button class="btn btn-sm btn-outline" onclick="alert('SprÃ¡va detailnÃ­ch rolÃ­ bude pÅ™idÃ¡na v dalÅ¡Ã­ verzi')">
                âš™ï¸ Spravovat
              </button>
            {% else %}
              <span style="color: #94a3b8; font-size: 0.875rem;">VlastnÃ­k</span>
            {% endif %}
          </td>
          {% endif %}
        </tr>
        {% empty %}
        <tr><td colspan="{% if is_admin %}4{% else %}3{% endif %}" class="data-table-empty">Å½Ã¡dnÃ­ ÄlenovÃ©</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- VysvÄ›tlenÃ­ zÃ¡kladnÃ­ch rolÃ­ -->
  <div class="content-card" style="margin-bottom: 2rem;">
    <h3 style="font-size: 1.25rem; font-weight: 600; color: #1e293b; margin-bottom: 1rem;">
      ğŸ“‹ ZÃ¡kladnÃ­ role v organizaci
    </h3>

    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem;">
      <div style="padding: 1rem; border: 2px solid #3b82f6; border-radius: 8px; background: #eff6ff;">
        <h4 style="font-weight: 600; color: #1e40af; margin-bottom: 0.5rem;">ğŸ‘‘ Admin</h4>
        <p style="font-size: 0.875rem; color: #1e293b; margin: 0;">
          PlnÃ¡ sprÃ¡va organizace vÄetnÄ› pÅ™idÃ¡vÃ¡nÃ­/odebÃ­rÃ¡nÃ­ ÄlenÅ¯, zmÄ›ny rolÃ­ a sprÃ¡vy IAM.
        </p>
      </div>

      <div style="padding: 1rem; border: 2px solid #10b981; border-radius: 8px; background: #f0fdf4;">
        <h4 style="font-weight: 600; color: #166534; margin-bottom: 0.5rem;">ğŸ‘¤ ÄŒlen</h4>
        <p style="font-size: 0.875rem; color: #1e293b; margin: 0;">
          StandardnÃ­ Älen s pÅ™Ã­stupem k projektÅ¯m a modulÅ¯m organizace podle pÅ™iÅ™azenÃ½ch modulovÃ½ch rolÃ­.
        </p>
      </div>

      <div style="padding: 1rem; border: 2px solid #64748b; border-radius: 8px; background: #f8fafc;">
        <h4 style="font-weight: 600; color: #475569; margin-bottom: 0.5rem;">ğŸ‘ï¸ Pozorovatel</h4>
        <p style="font-size: 0.875rem; color: #1e293b; margin: 0;">
          Pouze ÄtenÃ­ - mÅ¯Å¾e zobrazit informace, ale nemÅ¯Å¾e provÃ¡dÄ›t zmÄ›ny.
        </p>
      </div>
    </div>
  </div>

  <!-- OrganizaÄnÃ­ role (pokud existujÃ­) -->
  {% if org_roles %}
  <div class="content-card" style="margin-bottom: 2rem;">
    <h3 style="font-size: 1.25rem; font-weight: 600; color: #1e293b; margin-bottom: 1rem;">
      ğŸ¯ OrganizaÄnÃ­ role
    </h3>

    <table class="data-table">
      <thead>
        <tr>
          <th>UÅ¾ivatel</th>
          <th>Typ role</th>
          <th>OprÃ¡vnÄ›nÃ­</th>
          <th>PÅ™iÅ™azeno</th>
        </tr>
      </thead>
      <tbody>
        {% for role in org_roles %}
        <tr>
          <td><strong>{{ role.membership.user.username }}</strong></td>
          <td>
            <span style="background: #e0e7ff; color: #3730a3; padding: 4px 12px; border-radius: 12px; font-size: 0.875rem; font-weight: 500;">
              {{ role.role_type }}
            </span>
          </td>
          <td>
            {% for perm in role.permissions.all %}
              <span style="background: #f0fdf4; color: #166534; padding: 2px 8px; border-radius: 12px; font-size: 0.75rem; margin-right: 0.25rem;">
                {{ perm.name }}
              </span>
            {% empty %}
              <span style="color: #94a3b8; font-size: 0.875rem;">Å½Ã¡dnÃ¡ oprÃ¡vnÄ›nÃ­</span>
            {% endfor %}
          </td>
          <td style="font-size: 0.875rem; color: #64748b;">{{ role.assigned_at|date:"d.m.Y H:i" }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% endif %}

  <!-- ModulovÃ© role (pokud existujÃ­) -->
  {% if module_roles %}
  <div class="content-card">
    <h3 style="font-size: 1.25rem; font-weight: 600; color: #1e293b; margin-bottom: 1rem;">
      ğŸ“¦ ModulovÃ© role
    </h3>

    <table class="data-table">
      <thead>
        <tr>
          <th>UÅ¾ivatel</th>
          <th>Modul</th>
          <th>Typ role</th>
          <th>OprÃ¡vnÄ›nÃ­</th>
          <th>PÅ™iÅ™azeno</th>
        </tr>
      </thead>
      <tbody>
        {% for role in module_roles %}
        <tr>
          <td><strong>{{ role.membership.user.username }}</strong></td>
          <td>
            <span style="background: #f3f4f6; color: #1e293b; padding: 4px 8px; border-radius: 6px; font-size: 0.875rem;">
              {{ role.module.display_name }}
            </span>
          </td>
          <td>
            <span style="background: #fce7f3; color: #831843; padding: 4px 12px; border-radius: 12px; font-size: 0.875rem; font-weight: 500;">
              {{ role.role_type }}
            </span>
          </td>
          <td>
            {% for perm in role.permissions.all %}
              <span style="background: #f0fdf4; color: #166534; padding: 2px 8px; border-radius: 12px; font-size: 0.75rem; margin-right: 0.25rem;">
                {{ perm.name }}
              </span>
            {% empty %}
              <span style="color: #94a3b8; font-size: 0.875rem;">Å½Ã¡dnÃ¡ oprÃ¡vnÄ›nÃ­</span>
            {% endfor %}
          </td>
          <td style="font-size: 0.875rem; color: #64748b;">{{ role.assigned_at|date:"d.m.Y H:i" }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% endif %}

</div>

{% endblock %}
