{% extends "base.html" %}
{% block title %}AI PrÃ¡vnÃ­ asistent | FDK.cz{% endblock %}
{% block header_title %}ğŸ¤– AI PrÃ¡vnÃ­ asistent{% endblock %}
{% block header_subtitle %}InteraktivnÃ­ konzultace s AI o prÃ¡vnÃ­ch otÃ¡zkÃ¡ch{% endblock %}

{% block content %}
<div style="max-width: 1200px; margin: 0 auto;">
  <!-- Info Banner -->
  <div style="background: linear-gradient(135deg, #3b82f6, #4f46e5); color: white; border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);">
    <div style="display: flex; align-items: center; justify-content: space-between;">
      <div>
        <h2 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 0.5rem;">ğŸ’¡ VÃ­tejte u AI asistenta</h2>
        <p style="color: #dbeafe;">PoloÅ¾te mi jakoukoli prÃ¡vnÃ­ otÃ¡zku a pomohu vÃ¡m najÃ­t odpovÄ›Ä podle ÄeskÃ©ho prÃ¡va.</p>
      </div>
      <div style="font-size: 4rem; opacity: 0.5; display: none;">âš–ï¸</div>
    </div>
  </div>

  <!-- Quick Actions -->
  <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
    <button onclick="insertSampleQuery('JakÃ¡ jsou moje prÃ¡va pÅ™i reklamaci vadnÃ©ho zboÅ¾Ã­?')"
            style="background: white; border: 2px solid #e2e8f0; border-radius: 8px; padding: 1rem; text-align: left; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.borderColor='#3b82f6'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)'" onmouseout="this.style.borderColor='#e2e8f0'; this.style.boxShadow='none'">
      <div style="font-size: 2rem; margin-bottom: 0.5rem;">ğŸ›’</div>
      <div style="font-weight: 600; color: #1e293b; margin-bottom: 0.25rem;">Reklamace zboÅ¾Ã­</div>
      <div style="font-size: 0.75rem; color: #64748b;">PrÃ¡va spotÅ™ebitele</div>
    </button>
    <button onclick="insertSampleQuery('Jak sprÃ¡vnÄ› sepsat pracovnÃ­ smlouvu?')"
            style="background: white; border: 2px solid #e2e8f0; border-radius: 8px; padding: 1rem; text-align: left; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.borderColor='#3b82f6'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)'" onmouseout="this.style.borderColor='#e2e8f0'; this.style.boxShadow='none'">
      <div style="font-size: 2rem; margin-bottom: 0.5rem;">ğŸ“„</div>
      <div style="font-weight: 600; color: #1e293b; margin-bottom: 0.25rem;">PracovnÃ­ smlouva</div>
      <div style="font-size: 0.75rem; color: #64748b;">PracovnÃ­ prÃ¡vo</div>
    </button>
    <button onclick="insertSampleQuery('JakÃ© jsou povinnosti pronajÃ­matele bytu?')"
            style="background: white; border: 2px solid #e2e8f0; border-radius: 8px; padding: 1rem; text-align: left; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.borderColor='#3b82f6'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)'" onmouseout="this.style.borderColor='#e2e8f0'; this.style.boxShadow='none'">
      <div style="font-size: 2rem; margin-bottom: 0.5rem;">ğŸ </div>
      <div style="font-weight: 600; color: #1e293b; margin-bottom: 0.25rem;">NÃ¡jem bytu</div>
      <div style="font-size: 0.75rem; color: #64748b;">NÃ¡jemnÃ­ prÃ¡vo</div>
    </button>
  </div>

  <!-- Chat Container -->
  <div class="content-card">
    <!-- Chat Messages -->
    <div id="chat-messages" style="display: grid; gap: 1rem; margin-bottom: 1.5rem; max-height: 500px; overflow-y: auto; padding: 1rem; background: #f8fafc; border-radius: 8px;">
      {% if chat_history %}
        {% for message in chat_history %}
          {% if message.type == 'user' %}
            <!-- User Message -->
            <div style="display: flex; justify-content: flex-end;">
              <div style="max-width: 80%;">
                <div style="background: #3b82f6; color: white; border-radius: 12px; border-top-right-radius: 0; padding: 1rem; box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);">
                  <p style="line-height: 1.6; margin: 0;">{{ message.message }}</p>
                </div>
                <div style="font-size: 0.75rem; color: #64748b; margin-top: 0.25rem; text-align: right;">
                  ğŸ‘¤ Vy â€¢ {{ message.timestamp|date:"H:i" }}
                </div>
              </div>
            </div>
          {% else %}
            <!-- AI Message -->
            <div style="display: flex; justify-content: flex-start;">
              <div style="max-width: 80%;">
                <div style="background: white; border: 2px solid #e2e8f0; border-radius: 12px; border-top-left-radius: 0; padding: 1rem; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);">
                  <p style="line-height: 1.6; color: #1e293b; margin: 0;">{{ message.message }}</p>
                </div>
                <div style="font-size: 0.75rem; color: #64748b; margin-top: 0.25rem;">
                  ğŸ¤– AI Asistent â€¢ {{ message.timestamp|date:"H:i" }}
                </div>
              </div>
            </div>
          {% endif %}
        {% endfor %}
      {% else %}
        <!-- Welcome Message -->
        <div style="text-align: center; padding: 3rem;">
          <div style="font-size: 4rem; margin-bottom: 1rem;">ğŸ’¬</div>
          <h3 style="font-size: 1.25rem; font-weight: 600; color: #1e293b; margin-bottom: 0.5rem;">ZaÄnÄ›te konverzaci</h3>
          <p style="color: #64748b;">NapiÅ¡te vaÅ¡i prÃ¡vnÃ­ otÃ¡zku do pole nÃ­Å¾e nebo vyberte rychlou akci vÃ½Å¡e.</p>
        </div>
      {% endif %}
    </div>

    <!-- Chat Input -->
    <form id="chat-form" style="border-top: 2px solid #e2e8f0; padding-top: 1rem;">
      {% csrf_token %}
      <div style="display: flex; gap: 0.75rem;">
        <textarea
          id="message-input"
          name="message"
          rows="3"
          class="form-control"
          style="flex: 1; padding: 0.75rem; border: 1px solid #e2e8f0; border-radius: 8px; font-family: inherit; resize: vertical;"
          placeholder="NapiÅ¡te vaÅ¡i prÃ¡vnÃ­ otÃ¡zku..."
          required></textarea>
        <button type="submit" class="btn btn-primary" style="align-self: flex-end;">
          ğŸ“¤ Odeslat
        </button>
      </div>
      <div style="margin-top: 0.5rem; font-size: 0.75rem; color: #64748b;">
        StisknÄ›te Enter pro odeslÃ¡nÃ­, Shift+Enter pro novÃ½ Å™Ã¡dek
      </div>
    </form>
  </div>

  <!-- Disclaimer -->
  <div style="background: #fef3c7; border: 2px solid #fbbf24; border-radius: 8px; padding: 1rem; margin-top: 1.5rem;">
    <div style="display: flex; align-items: flex-start;">
      <div style="font-size: 1.5rem; margin-right: 0.75rem;">âš ï¸</div>
      <div>
        <h4 style="font-weight: 600; color: #92400e; margin-bottom: 0.25rem;">UpozornÄ›nÃ­</h4>
        <p style="font-size: 0.875rem; color: #b45309; margin: 0; line-height: 1.6;">
          AI asistent poskytuje obecnÃ© prÃ¡vnÃ­ informace a nepÅ™edstavuje prÃ¡vnÃ­ poradenstvÃ­.
          OdpovÄ›di jsou generovÃ¡ny umÄ›lou inteligencÃ­ a mohou obsahovat nepÅ™esnosti.
          Pro konkrÃ©tnÃ­ prÃ¡vnÃ­ pÅ™Ã­pady doporuÄujeme konzultaci s kvalifikovanÃ½m advokÃ¡tem.
        </p>
      </div>
    </div>
  </div>

  <!-- Additional Actions -->
  <div style="display: flex; gap: 0.75rem; margin-top: 1.5rem; flex-wrap: wrap;">
    <a href="{% url 'create_query' %}" class="btn btn-outline">ğŸ“ VytvoÅ™it komplexnÃ­ dotaz</a>
    <a href="{% url 'pravo_ai' %}" class="btn btn-outline">â† ZpÄ›t na AI PrÃ¡vo</a>
    <button onclick="clearChat()" class="btn btn-outline">ğŸ—‘ï¸ Vymazat konverzaci</button>
  </div>
</div>

<script>
// Chat form submission
document.getElementById('chat-form').addEventListener('submit', async function(e) {
  e.preventDefault();

  const messageInput = document.getElementById('message-input');
  const message = messageInput.value.trim();

  if (!message) return;

  // Add user message to chat
  addMessageToChat('user', message);
  messageInput.value = '';

  // Show typing indicator
  const typingId = addTypingIndicator();

  // Send message to server
  try {
    const formData = new FormData();
    formData.append('message', message);
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);

    const response = await fetch('{% url "law_ai_assistant" %}', {
      method: 'POST',
      headers: {
        'X-Requested-With': 'XMLHttpRequest',
      },
      body: formData
    });

    const data = await response.json();

    // Remove typing indicator
    removeTypingIndicator(typingId);

    // Add AI response
    addMessageToChat('ai', data.response);

  } catch (error) {
    removeTypingIndicator(typingId);
    addMessageToChat('ai', 'OmlouvÃ¡me se, doÅ¡lo k chybÄ› pÅ™i zpracovÃ¡nÃ­ vaÅ¡Ã­ zprÃ¡vy. Zkuste to prosÃ­m znovu.');
  }
});

// Add message to chat
function addMessageToChat(type, message) {
  const chatMessages = document.getElementById('chat-messages');
  const time = new Date().toLocaleTimeString('cs-CZ', { hour: '2-digit', minute: '2-digit' });

  const messageDiv = document.createElement('div');
  messageDiv.style.display = 'flex';
  messageDiv.style.justifyContent = type === 'user' ? 'flex-end' : 'flex-start';

  if (type === 'user') {
    messageDiv.innerHTML = `
      <div style="max-width: 80%;">
        <div style="background: #3b82f6; color: white; border-radius: 12px; border-top-right-radius: 0; padding: 1rem; box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);">
          <p style="line-height: 1.6; margin: 0;">${escapeHtml(message)}</p>
        </div>
        <div style="font-size: 0.75rem; color: #64748b; margin-top: 0.25rem; text-align: right;">
          ğŸ‘¤ Vy â€¢ ${time}
        </div>
      </div>
    `;
  } else {
    messageDiv.innerHTML = `
      <div style="max-width: 80%;">
        <div style="background: white; border: 2px solid #e2e8f0; border-radius: 12px; border-top-left-radius: 0; padding: 1rem; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);">
          <p style="line-height: 1.6; color: #1e293b; margin: 0;">${escapeHtml(message)}</p>
        </div>
        <div style="font-size: 0.75rem; color: #64748b; margin-top: 0.25rem;">
          ğŸ¤– AI Asistent â€¢ ${time}
        </div>
      </div>
    `;
  }

  chatMessages.appendChild(messageDiv);
  chatMessages.scrollTop = chatMessages.scrollHeight;
}

// Add typing indicator
function addTypingIndicator() {
  const chatMessages = document.getElementById('chat-messages');
  const typingDiv = document.createElement('div');
  typingDiv.id = 'typing-indicator';
  typingDiv.style.display = 'flex';
  typingDiv.style.justifyContent = 'flex-start';
  typingDiv.innerHTML = `
    <div style="background: white; border: 2px solid #e2e8f0; border-radius: 12px; padding: 1rem;">
      <div style="display: flex; gap: 0.5rem;">
        <div style="width: 8px; height: 8px; background: #94a3b8; border-radius: 50%; animation: bounce 1.4s infinite;"></div>
        <div style="width: 8px; height: 8px; background: #94a3b8; border-radius: 50%; animation: bounce 1.4s infinite 0.2s;"></div>
        <div style="width: 8px; height: 8px; background: #94a3b8; border-radius: 50%; animation: bounce 1.4s infinite 0.4s;"></div>
      </div>
    </div>
  `;
  chatMessages.appendChild(typingDiv);
  chatMessages.scrollTop = chatMessages.scrollHeight;
  return 'typing-indicator';
}

// Remove typing indicator
function removeTypingIndicator(id) {
  const indicator = document.getElementById(id);
  if (indicator) indicator.remove();
}

// Insert sample query
function insertSampleQuery(query) {
  document.getElementById('message-input').value = query;
  document.getElementById('message-input').focus();
}

// Clear chat
function clearChat() {
  if (confirm('Opravdu chcete vymazat celou konverzaci?')) {
    const chatMessages = document.getElementById('chat-messages');
    chatMessages.innerHTML = `
      <div style="text-align: center; padding: 3rem;">
        <div style="font-size: 4rem; margin-bottom: 1rem;">ğŸ’¬</div>
        <h3 style="font-size: 1.25rem; font-weight: 600; color: #1e293b; margin-bottom: 0.5rem;">ZaÄnÄ›te konverzaci</h3>
        <p style="color: #64748b;">NapiÅ¡te vaÅ¡i prÃ¡vnÃ­ otÃ¡zku do pole nÃ­Å¾e nebo vyberte rychlou akci vÃ½Å¡e.</p>
      </div>
    `;
  }
}

// Escape HTML
function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// Enter to submit
document.getElementById('message-input').addEventListener('keydown', function(e) {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    document.getElementById('chat-form').dispatchEvent(new Event('submit'));
  }
});
</script>

<style>
@keyframes bounce {
  0%, 80%, 100% {
    transform: translateY(0);
  }
  40% {
    transform: translateY(-10px);
  }
}
</style>
{% endblock %}
