{% extends "base.html" %}
{% block title %}AI PrÃ¡vnÃ­ asistent | FDK.cz{% endblock %}
{% block header_title %}ğŸ¤– AI PrÃ¡vnÃ­ asistent{% endblock %}
{% block header_subtitle %}InteraktivnÃ­ konzultace s AI o prÃ¡vnÃ­ch otÃ¡zkÃ¡ch{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto">
  <!-- Info Banner -->
  <div class="bg-gradient-to-r from-blue-500 to-indigo-600 text-white rounded-lg p-6 mb-6 shadow-lg">
    <div class="flex items-center justify-between">
      <div>
        <h2 class="text-2xl font-bold mb-2">ğŸ’¡ VÃ­tejte u AI asistenta</h2>
        <p class="text-blue-100">PoloÅ¾te mi jakoukoli prÃ¡vnÃ­ otÃ¡zku a pomohu vÃ¡m najÃ­t odpovÄ›Ä podle ÄeskÃ©ho prÃ¡va.</p>
      </div>
      <div class="hidden md:block text-6xl opacity-50">âš–ï¸</div>
    </div>
  </div>

  <!-- Quick Actions -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
    <button onclick="insertSampleQuery('JakÃ¡ jsou moje prÃ¡va pÅ™i reklamaci vadnÃ©ho zboÅ¾Ã­?')"
            class="bg-white border-2 border-gray-200 hover:border-blue-400 rounded-lg p-4 text-left transition-all hover:shadow-md">
      <div class="text-2xl mb-2">ğŸ›’</div>
      <div class="font-semibold text-gray-800 mb-1">Reklamace zboÅ¾Ã­</div>
      <div class="text-xs text-gray-600">PrÃ¡va spotÅ™ebitele</div>
    </button>
    <button onclick="insertSampleQuery('Jak sprÃ¡vnÄ› sepsat pracovnÃ­ smlouvu?')"
            class="bg-white border-2 border-gray-200 hover:border-blue-400 rounded-lg p-4 text-left transition-all hover:shadow-md">
      <div class="text-2xl mb-2">ğŸ“„</div>
      <div class="font-semibold text-gray-800 mb-1">PracovnÃ­ smlouva</div>
      <div class="text-xs text-gray-600">PracovnÃ­ prÃ¡vo</div>
    </button>
    <button onclick="insertSampleQuery('JakÃ© jsou povinnosti pronajÃ­matele bytu?')"
            class="bg-white border-2 border-gray-200 hover:border-blue-400 rounded-lg p-4 text-left transition-all hover:shadow-md">
      <div class="text-2xl mb-2">ğŸ </div>
      <div class="font-semibold text-gray-800 mb-1">NÃ¡jem bytu</div>
      <div class="text-xs text-gray-600">NÃ¡jemnÃ­ prÃ¡vo</div>
    </button>
  </div>

  <!-- Chat Container -->
  <div class="content-card">
    <!-- Chat Messages -->
    <div id="chat-messages" class="space-y-4 mb-6 max-h-[500px] overflow-y-auto p-4 bg-gray-50 rounded-lg">
      {% if chat_history %}
        {% for message in chat_history %}
          {% if message.type == 'user' %}
            <!-- User Message -->
            <div class="flex justify-end">
              <div class="max-w-[80%]">
                <div class="bg-blue-600 text-white rounded-lg rounded-tr-none p-4 shadow-md">
                  <p class="leading-relaxed">{{ message.message }}</p>
                </div>
                <div class="text-xs text-gray-500 mt-1 text-right">
                  ğŸ‘¤ Vy â€¢ {{ message.timestamp|date:"H:i" }}
                </div>
              </div>
            </div>
          {% else %}
            <!-- AI Message -->
            <div class="flex justify-start">
              <div class="max-w-[80%]">
                <div class="bg-white border-2 border-gray-200 rounded-lg rounded-tl-none p-4 shadow-md">
                  <p class="leading-relaxed text-gray-800">{{ message.message }}</p>
                </div>
                <div class="text-xs text-gray-500 mt-1">
                  ğŸ¤– AI Asistent â€¢ {{ message.timestamp|date:"H:i" }}
                </div>
              </div>
            </div>
          {% endif %}
        {% endfor %}
      {% else %}
        <!-- Welcome Message -->
        <div class="text-center py-12">
          <div class="text-6xl mb-4">ğŸ’¬</div>
          <h3 class="text-xl font-semibold text-gray-800 mb-2">ZaÄnÄ›te konverzaci</h3>
          <p class="text-gray-600">NapiÅ¡te vaÅ¡i prÃ¡vnÃ­ otÃ¡zku do pole nÃ­Å¾e nebo vyberte rychlou akci vÃ½Å¡e.</p>
        </div>
      {% endif %}
    </div>

    <!-- Chat Input -->
    <form id="chat-form" class="border-t-2 border-gray-200 pt-4">
      {% csrf_token %}
      <div class="flex gap-3">
        <textarea
          id="message-input"
          name="message"
          rows="3"
          class="form-control flex-1"
          placeholder="NapiÅ¡te vaÅ¡i prÃ¡vnÃ­ otÃ¡zku..."
          required></textarea>
        <button type="submit" class="btn btn-primary self-end">
          ğŸ“¤ Odeslat
        </button>
      </div>
      <div class="mt-2 text-xs text-gray-500">
        StisknÄ›te Enter pro odeslÃ¡nÃ­, Shift+Enter pro novÃ½ Å™Ã¡dek
      </div>
    </form>
  </div>

  <!-- Disclaimer -->
  <div class="bg-yellow-50 border-2 border-yellow-200 rounded-lg p-4 mt-6">
    <div class="flex items-start">
      <div class="text-2xl mr-3">âš ï¸</div>
      <div>
        <h4 class="font-semibold text-yellow-800 mb-1">UpozornÄ›nÃ­</h4>
        <p class="text-sm text-yellow-700">
          AI asistent poskytuje obecnÃ© prÃ¡vnÃ­ informace a nepÅ™edstavuje prÃ¡vnÃ­ poradenstvÃ­.
          OdpovÄ›di jsou generovÃ¡ny umÄ›lou inteligencÃ­ a mohou obsahovat nepÅ™esnosti.
          Pro konkrÃ©tnÃ­ prÃ¡vnÃ­ pÅ™Ã­pady doporuÄujeme konzultaci s kvalifikovanÃ½m advokÃ¡tem.
        </p>
      </div>
    </div>
  </div>

  <!-- Additional Actions -->
  <div class="flex gap-3 mt-6">
    <a href="{% url 'create_query' %}" class="btn btn-secondary">ğŸ“ VytvoÅ™it komplexnÃ­ dotaz</a>
    <a href="{% url 'law_dashboard' %}" class="btn btn-outline">â† ZpÄ›t na dashboard</a>
    <button onclick="clearChat()" class="btn btn-outline">ğŸ—‘ï¸ Vymazat konverzaci</button>
  </div>
</div>

<script>
// Chat form submission
document.getElementById('chat-form').addEventListener('submit', async function(e) {
  e.preventDefault();

  const messageInput = document.getElementById('message-input');
  const message = messageInput.value.trim();

  if (!message) return;

  // Add user message to chat
  addMessageToChat('user', message);
  messageInput.value = '';

  // Show typing indicator
  const typingId = addTypingIndicator();

  // Send message to server
  try {
    const formData = new FormData();
    formData.append('message', message);
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);

    const response = await fetch('{% url "ai_assistant" %}', {
      method: 'POST',
      headers: {
        'X-Requested-With': 'XMLHttpRequest',
      },
      body: formData
    });

    const data = await response.json();

    // Remove typing indicator
    removeTypingIndicator(typingId);

    // Add AI response
    addMessageToChat('ai', data.response);

  } catch (error) {
    removeTypingIndicator(typingId);
    addMessageToChat('ai', 'OmlouvÃ¡me se, doÅ¡lo k chybÄ› pÅ™i zpracovÃ¡nÃ­ vaÅ¡Ã­ zprÃ¡vy. Zkuste to prosÃ­m znovu.');
  }
});

// Add message to chat
function addMessageToChat(type, message) {
  const chatMessages = document.getElementById('chat-messages');
  const time = new Date().toLocaleTimeString('cs-CZ', { hour: '2-digit', minute: '2-digit' });

  const messageDiv = document.createElement('div');
  messageDiv.className = type === 'user' ? 'flex justify-end' : 'flex justify-start';

  if (type === 'user') {
    messageDiv.innerHTML = `
      <div class="max-w-[80%]">
        <div class="bg-blue-600 text-white rounded-lg rounded-tr-none p-4 shadow-md">
          <p class="leading-relaxed">${escapeHtml(message)}</p>
        </div>
        <div class="text-xs text-gray-500 mt-1 text-right">
          ğŸ‘¤ Vy â€¢ ${time}
        </div>
      </div>
    `;
  } else {
    messageDiv.innerHTML = `
      <div class="max-w-[80%]">
        <div class="bg-white border-2 border-gray-200 rounded-lg rounded-tl-none p-4 shadow-md">
          <p class="leading-relaxed text-gray-800">${escapeHtml(message)}</p>
        </div>
        <div class="text-xs text-gray-500 mt-1">
          ğŸ¤– AI Asistent â€¢ ${time}
        </div>
      </div>
    `;
  }

  chatMessages.appendChild(messageDiv);
  chatMessages.scrollTop = chatMessages.scrollHeight;
}

// Add typing indicator
function addTypingIndicator() {
  const chatMessages = document.getElementById('chat-messages');
  const typingDiv = document.createElement('div');
  typingDiv.id = 'typing-indicator';
  typingDiv.className = 'flex justify-start';
  typingDiv.innerHTML = `
    <div class="bg-white border-2 border-gray-200 rounded-lg p-4">
      <div class="flex space-x-2">
        <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div>
        <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
        <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
      </div>
    </div>
  `;
  chatMessages.appendChild(typingDiv);
  chatMessages.scrollTop = chatMessages.scrollHeight;
  return 'typing-indicator';
}

// Remove typing indicator
function removeTypingIndicator(id) {
  const indicator = document.getElementById(id);
  if (indicator) indicator.remove();
}

// Insert sample query
function insertSampleQuery(query) {
  document.getElementById('message-input').value = query;
  document.getElementById('message-input').focus();
}

// Clear chat
function clearChat() {
  if (confirm('Opravdu chcete vymazat celou konverzaci?')) {
    const chatMessages = document.getElementById('chat-messages');
    chatMessages.innerHTML = `
      <div class="text-center py-12">
        <div class="text-6xl mb-4">ğŸ’¬</div>
        <h3 class="text-xl font-semibold text-gray-800 mb-2">ZaÄnÄ›te konverzaci</h3>
        <p class="text-gray-600">NapiÅ¡te vaÅ¡i prÃ¡vnÃ­ otÃ¡zku do pole nÃ­Å¾e nebo vyberte rychlou akci vÃ½Å¡e.</p>
      </div>
    `;
  }
}

// Escape HTML
function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// Enter to submit
document.getElementById('message-input').addEventListener('keydown', function(e) {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    document.getElementById('chat-form').dispatchEvent(new Event('submit'));
  }
});
</script>
{% endblock %}
